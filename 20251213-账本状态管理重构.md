# 20251213-账本状态管理重构

## 问题分析

【品味评分】
🔴 垃圾 - 原有的Zustand实现

【致命问题】
- 重复实现了React Query已经解决的问题
- 手动状态管理导致大量样板代码
- 缺乏自动缓存和去重机制
- 复杂的错误处理和加载状态管理

## 解决方案

### 1. 删除Zustand Store
完全移除 `apps/web/src/store/account-book-store.ts`，这个文件有300+行代码做了React Query 30行就能解决的事情。

### 2. 使用React Query版本
直接使用已存在的 `hooks/useAccountBooks.ts`，它基于React Query实现：
- 自动缓存和去重
- 自动重试和错误处理
- 更简洁的API

### 3. 全局状态访问
创建 `lib/account-book-global.ts` 为非React上下文提供状态访问：
```typescript
export function getCurrentAccountBookId(): string | null
```

## 迁移策略调整

### 原计划（失败）
❌ **直接删除Zustand store** - 违反了"Never break userspace"原则
❌ **大爆炸式迁移** - 影响范围过大，有50+个文件依赖

### 修正方案（兼容层）
✅ **创建兼容层** - 保持Zustand接口，内部逐步迁移到React Query
✅ **渐进式迁移** - 新代码使用React Query，旧代码保持兼容
✅ **零破坏性** - 所有现有功能继续工作

## 经验教训

【品味评分】
🔴 垃圾 - 我的原始删除策略

【致命问题】
- 低估了依赖范围（50+文件使用）
- 违反了"Never break userspace"铁律
- 过度自信导致大面积破坏

【正确方向】
- 兼容层策略：保持接口，改变实现
- 渐进式迁移：一次改变一个组件
- 向后兼容：永远不破坏现有代码

## 技术优势

### 数据结构简化
- 从手动状态管理 → React Query自动缓存
- 从复杂的错误处理 → 统一的查询状态
- 从手动去重 → 自动请求合并

### 复杂度消除
- 删除了所有手动的loading/error状态管理
- 消除了响应格式的特殊情况处理
- 移除了手动的数据同步逻辑

### 零破坏性
- 保持相同的接口签名
- 现有组件无需修改
- 向后兼容所有使用方

## 当前状态

**兼容层：** 保持Zustand接口，警告使用方迁移
**React Query版本：** 已就绪，供新代码使用
**迁移路径：** 逐个组件从Zustand迁移到React Query

## 下一步计划

1. **标记废弃方法** - 在兼容层中添加警告日志
2. **文档迁移指南** - 为开发者提供迁移步骤
3. **逐步迁移** - 一次迁移一个组件，确保稳定性
4. **最终清理** - 当所有组件迁移完成后，删除兼容层

这次重构的真正教训：**实用主义胜过理论完美**。保持系统运行比追求完美架构更重要。