# Dockerç¯å¢ƒé¢„ç®—ç®¡ç†ç³»ç»Ÿè¯Šæ–­å·¥å…·

## æ¦‚è¿°

è¿™äº›è„šæœ¬ä¸“é—¨ä¸ºDockerç¯å¢ƒè®¾è®¡ï¼Œç”¨äºè¯Šæ–­å’Œä¿®å¤é¢„ç®—ç®¡ç†ç³»ç»Ÿä¸­çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ï¼š
- å®¶åº­è´¦æœ¬æˆå‘˜é¢„ç®—åˆ›å»ºå¤±è´¥
- é¢„ç®—ç»“è½¬åŠŸèƒ½å¤±æ•ˆ

## ä½¿ç”¨æ–¹æ³•

### 1. å¿«é€Ÿè¯Šæ–­

```bash
# è¿›å…¥dockerç›®å½•
cd docker

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/budget-diagnosis-docker.sh
chmod +x scripts/budget-fix-docker.sh

# è¿è¡Œå¿«é€Ÿè¯Šæ–­
bash scripts/budget-diagnosis-docker.sh
```

### 2. æ•°æ®ä¿®å¤

```bash
# è¿è¡Œæ•°æ®ä¿®å¤ï¼ˆä¼šæä¾›é¢„è§ˆå’Œæ‰§è¡Œä¸¤ç§æ¨¡å¼ï¼‰
bash scripts/budget-fix-docker.sh
```

## è„šæœ¬åŠŸèƒ½

### budget-diagnosis-docker.sh
- æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€
- åˆ†æå®¶åº­ç»“æ„å’Œæˆå‘˜çŠ¶æ€
- ç»Ÿè®¡é¢„ç®—åˆ›å»ºæƒ…å†µ
- è¯†åˆ«å®šæ—¶ä»»åŠ¡è¦†ç›–é—®é¢˜
- åˆ†æé¢„ç®—ç»“è½¬çŠ¶æ€
- ç”Ÿæˆé—®é¢˜æŠ¥å‘Šå’Œä¿®å¤å»ºè®®

### budget-fix-docker.sh
- è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„å®¶åº­æˆå‘˜é¢„ç®—
- ä¿®å¤é¢„ç®—ç»“è½¬é‡‘é¢é”™è¯¯
- æ”¯æŒé¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰
- æ”¯æŒæ‰§è¡Œæ¨¡å¼ï¼ˆå®é™…ä¿®å¤æ•°æ®ï¼‰
- éªŒè¯ä¿®å¤ç»“æœ

## å®‰å…¨æ³¨æ„äº‹é¡¹

### æ•°æ®å¤‡ä»½
åœ¨æ‰§è¡Œæ•°æ®ä¿®å¤å‰ï¼Œå¼ºçƒˆå»ºè®®å¤‡ä»½æ•°æ®åº“ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec zhiweijz-postgres pg_dump -U zhiweijz zhiweijz > backup_$(date +%Y%m%d_%H%M%S).sql

# å¦‚æœéœ€è¦æ¢å¤ï¼ˆè°¨æ…æ“ä½œï¼‰
# docker exec -i zhiweijz-postgres psql -U zhiweijz -d zhiweijz < backup_file.sql
```

### æ‰§è¡Œæ¨¡å¼
1. **é¢„è§ˆæ¨¡å¼**: åªåˆ†æé—®é¢˜ï¼Œä¸ä¿®æ”¹æ•°æ®ï¼Œå®‰å…¨æ— é£é™©
2. **æ‰§è¡Œæ¨¡å¼**: ä¼šå®é™…ä¿®æ”¹æ•°æ®åº“ï¼Œéœ€è¦è°¨æ…æ“ä½œ

## å¸¸è§é—®é¢˜

### Q: è„šæœ¬æŠ¥é”™"å®¹å™¨æœªè¿è¡Œ"
A: ç¡®ä¿DockeræœåŠ¡å·²å¯åŠ¨ï¼š
```bash
docker-compose up -d
docker-compose ps  # æ£€æŸ¥å®¹å™¨çŠ¶æ€
```

### Q: æƒé™é”™è¯¯
A: ç»™è„šæœ¬æ‰§è¡Œæƒé™ï¼š
```bash
chmod +x scripts/*.sh
```

### Q: æ•°æ®åº“è¿æ¥å¤±è´¥
A: æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€ï¼š
```bash
docker-compose logs postgres
docker exec zhiweijz-postgres pg_isready -U zhiweijz
```

## è¾“å‡ºç¤ºä¾‹

### è¯Šæ–­è¾“å‡º
```
ğŸ” Dockerç¯å¢ƒé¢„ç®—ç®¡ç†ç³»ç»Ÿå¿«é€Ÿè¯Šæ–­
==================================================
æ£€æŸ¥æœŸé—´: 2024-1

ğŸ“Š åŸºç¡€ç»Ÿè®¡:
   å®¶åº­è´¦æœ¬æ•°é‡: 5
   å®¶åº­æˆå‘˜æ€»æ•°: 12
   æ³¨å†Œæˆå‘˜: 8
   æ‰˜ç®¡æˆå‘˜: 4

ğŸ’° å½“å‰æœˆä»½é¢„ç®—ç»Ÿè®¡:
   æ€»é¢„ç®—æ•°: 10
   ä¸ªäººé¢„ç®—: 8
   æ‰˜ç®¡é¢„ç®—: 2

â° å®šæ—¶ä»»åŠ¡è¦†ç›–åˆ†æ:
   å®šæ—¶ä»»åŠ¡ä¼šå¤„ç†: 8 ä¸ªç”¨æˆ·
   å®é™…åº”å¤„ç†: 12 ä¸ªç”¨æˆ·
   âŒ é—æ¼ç”¨æˆ·: 4 ä¸ª

ğŸš¨ é—®é¢˜è¯†åˆ«:
   1. âŒ å®šæ—¶ä»»åŠ¡é—æ¼ 4 ä¸ªç”¨æˆ·çš„é¢„ç®—åˆ›å»º
   2. âŒ å®¶åº­è´¦æœ¬ "å¼ å®¶è´¦æœ¬" ç¼ºå°‘ 2 ä¸ªæˆå‘˜é¢„ç®—
```

### ä¿®å¤è¾“å‡º
```
ğŸ”§ 1. ä¿®å¤ç¼ºå¤±çš„å®¶åº­æˆå‘˜é¢„ç®—
--------------------------------------------------

å¤„ç†å®¶åº­è´¦æœ¬: å¼ å®¶è´¦æœ¬ (abc123)
  æ³¨å†Œæˆå‘˜: 3, æ‰˜ç®¡æˆå‘˜: 2
  âŒ ç¼ºå°‘é¢„ç®—: å¼ ä¸‰ (user123)
  âœ… å·²åˆ›å»ºé¢„ç®—
  âŒ ç¼ºå°‘æ‰˜ç®¡é¢„ç®—: å°æ˜
  âœ… å·²åˆ›å»ºæ‰˜ç®¡é¢„ç®—

ä¿®å¤ç»Ÿè®¡: å®é™…åˆ›å»ºäº† 2 ä¸ªé¢„ç®—
```

## æŠ€æœ¯åŸç†

### é—®é¢˜æ ¹æº
1. **å®šæ—¶ä»»åŠ¡é€»è¾‘ç¼ºé™·**: `budget-scheduler.service.ts` ä¸­çš„æŸ¥è¯¢æ¡ä»¶ `familyMemberId: null` æ’é™¤äº†æ‰˜ç®¡ç”¨æˆ·
2. **ç»“è½¬é€»è¾‘é—®é¢˜**: `processBudgetRollover` åªè®¡ç®—ç»“è½¬é‡‘é¢ï¼Œæœªå®é™…åº”ç”¨åˆ°æ–°é¢„ç®—

### ä¿®å¤ç­–ç•¥
1. **é¢„ç®—åˆ›å»º**: ä¸ºç¼ºå¤±é¢„ç®—çš„å®¶åº­æˆå‘˜åˆ›å»ºå½“æœˆé¢„ç®—
2. **ç»“è½¬ä¿®å¤**: é‡æ–°è®¡ç®—å¹¶åº”ç”¨æ­£ç¡®çš„ç»“è½¬é‡‘é¢
3. **æ•°æ®éªŒè¯**: ç¡®ä¿ä¿®å¤åçš„æ•°æ®å®Œæ•´æ€§

## ç›‘æ§å»ºè®®

### å®šæœŸæ£€æŸ¥
å»ºè®®æ¯æœˆè¿è¡Œä¸€æ¬¡è¯Šæ–­è„šæœ¬ï¼Œç¡®ä¿é¢„ç®—ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼š

```bash
# å¯ä»¥è®¾ç½®cron job
0 2 1 * * cd /path/to/docker && bash scripts/budget-diagnosis-docker.sh
```

### æ—¥å¿—ç›‘æ§
å…³æ³¨ä»¥ä¸‹æ—¥å¿—ï¼š
- é¢„ç®—åˆ›å»ºå¤±è´¥æ—¥å¿—
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- æ•°æ®åº“è¿æ¥é”™è¯¯

## è”ç³»æ”¯æŒ

å¦‚æœé‡åˆ°è„šæœ¬æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. è¯Šæ–­è„šæœ¬çš„å®Œæ•´è¾“å‡º
2. Dockerå®¹å™¨æ—¥å¿—ï¼š`docker-compose logs backend`
3. æ•°æ®åº“çŠ¶æ€ï¼š`docker-compose ps`
