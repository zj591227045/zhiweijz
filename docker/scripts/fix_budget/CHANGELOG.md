# 预算修复脚本 - 更新日志

## v2.2 (2025-10-01)

### 🎉 重大更新

#### 1. 重构 `run_budget_fix.sh` 为模块化设计
- **交互式菜单模式**：提供友好的菜单界面，可独立选择执行功能
- **命令行参数模式**：支持通过参数直接执行特定功能，适合自动化脚本
- **模块化函数设计**：将三个主要功能封装为独立函数，便于维护和扩展

#### 2. 新增交互式菜单
```
==========================================
       预算修复脚本 - 交互式菜单
==========================================

请选择要执行的操作:

  1) 创建缺失的YYYY年MM月个人预算
  2) 修复预算结转历史记录
  3) 修复已创建预算的结转金额
  4) 执行所有操作 (1+2+3)
  0) 退出

==========================================
```

#### 3. 支持命令行参数
新增以下命令行选项：
- `-a, --all`: 执行所有修复操作
- `-c, --create`: 仅创建缺失的预算
- `-h, --history`: 仅修复结转历史记录
- `-r, --rollover`: 仅修复结转金额
- `-i, --interactive`: 交互式选择（默认）
- `--help`: 显示帮助信息

#### 4. 改进用户体验
- 更清晰的日志输出
- 更友好的错误提示
- 更灵活的执行方式
- 更详细的帮助信息

#### 5. 新增文档
- `QUICK_REFERENCE.md`: 快速参考指南
- `CHANGELOG.md`: 更新日志（本文档）
- 更新 `README.md`: 完善使用说明

### 📝 使用示例

#### 交互式模式（推荐新手）
```bash
./run_budget_fix.sh
```

#### 命令行模式（推荐自动化）
```bash
# 仅创建预算
./run_budget_fix.sh -c 2025 9

# 仅修复历史
./run_budget_fix.sh -h

# 仅修复结转
./run_budget_fix.sh -r

# 执行所有操作
./run_budget_fix.sh -a 2025 10
```

### 🔧 技术改进
- 函数化设计，提高代码复用性
- 改进错误处理机制
- 优化参数解析逻辑
- 增强日志输出格式

### 📚 文档更新
- 更新 README.md，添加新功能说明
- 新增 QUICK_REFERENCE.md 快速参考
- 新增 CHANGELOG.md 更新日志
- 完善使用示例和故障排除

---

## v2.1 (2025-09-30)

### ✨ 新功能

#### 1. 新增 `fix_existing_budget_rollover_amount.sql` 脚本
解决已创建预算的结转金额不会自动更新的问题。

**功能：**
- 对比所有已创建预算的结转金额是否正确
- 修复所有结转金额错误的个人预算
- 确保预算结转链条的完整性和正确性

**使用场景：**
- 交易数据发生变化后，需要重新计算结转金额
- 上期预算的结转金额被修正后，需要更新下期预算
- 定期检查和修复预算结转金额的准确性

#### 2. 集成到自动化脚本
将新脚本集成到 `run_budget_fix.sh` 中，提供交互式选择。

#### 3. 新增使用文档
创建 `USAGE_EXAMPLE.md`，提供详细的使用示例和验证查询。

### 🔧 技术细节

**结转金额计算公式：**
```
结转金额 = 预算金额 + 上期结转金额 - 实际支出
```

**误差容忍：**
允许 0.01 元的小数点误差，避免浮点数计算误差导致的误报。

**处理顺序：**
按用户ID、账本ID、预算结束日期排序，确保预算链条按时间顺序正确处理。

### 📚 文档更新
- 更新 README.md，添加新脚本说明
- 新增 USAGE_EXAMPLE.md 使用示例
- 完善验证查询和常见问题

---

## v2.0 (2025-09-15)

### 🎉 重大升级

#### 1. 升级为通用工具
从专门修复9月份预算升级为支持任意月份修复的通用工具。

**改进：**
- 支持通过参数指定目标年月
- 默认使用当前月份
- 灵活的时间范围计算

#### 2. 添加自动化执行脚本
创建 `run_budget_fix.sh` 自动化脚本。

**功能：**
- 自动读取 `docker/.env` 配置
- 自动连接数据库
- 提供交互式确认
- 详细的错误处理

#### 3. 改进错误处理
- 事务保护，失败自动回滚
- 详细的日志输出
- 友好的错误提示

#### 4. 支持多种连接方式
自动尝试多种数据库连接方式：
1. 配置的主机
2. Docker容器名
3. localhost
4. 127.0.0.1

### 📚 文档完善
- 创建完整的 README.md
- 添加详细的使用说明
- 提供验证查询示例
- 添加故障排除指南

---

## v1.0 (2025-09-01)

### 🎉 初始版本

#### 1. 基础功能
- 为所有注册用户创建缺失的9月份个人预算
- 为所有托管用户创建缺失的9月份个人预算
- 为所有托管成员创建缺失的9月份个人预算

#### 2. 预算结转逻辑
- 正确处理预算结转（余额结转和债务结转）
- 自动创建上个月的预算结转历史记录
- 基于上个月预算计算结转金额

#### 3. 数据完整性
- 保持所有外键关联关系的正确性
- 确保所有必需字段都有正确的值
- 使用北京时间确保时间的一致性

#### 4. 安全特性
- 事务保护，出错时自动回滚
- 可以安全地重复执行
- 详细的执行日志

### 📝 处理对象
- `users` 表中 `is_custodial = false` 的注册用户
- `users` 表中 `is_custodial = true` 的托管用户
- `family_members` 表中 `is_custodial = true` 的托管成员

---

## 未来计划

### v2.3 (计划中)
- [ ] 支持批量处理多个月份
- [ ] 添加数据导出功能
- [ ] 支持自定义验证规则
- [ ] 添加性能优化选项

### v3.0 (规划中)
- [ ] Web界面支持
- [ ] 定时任务调度
- [ ] 邮件通知功能
- [ ] 详细的执行报告

---

## 贡献者
- Jackson - 主要开发者

## 许可证
内部项目，仅供ZhiWeiJZ项目使用

---

**最后更新：** 2025-10-01  
**当前版本：** v2.2

