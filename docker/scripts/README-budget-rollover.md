# 预算结转专用修复工具使用说明

## 概述

预算结转专用修复工具是针对预算结转功能的专门诊断和修复工具，解决以下问题：
- 预算结转金额计算错误
- 预算结转历史记录缺失
- 负数预算（债务）处理异常
- 结转链条断裂

## 功能特性

### 🔍 诊断模式
- 分析预算结转问题
- 检查结转金额是否正确
- 识别缺失的当月预算
- 验证结转计算逻辑

### 🔧 修复模式
- 修复错误的结转金额
- 补充缺失的结转历史记录
- 处理负数预算结转
- 验证修复结果

### 🔄 重新计算模式
- 重新计算所有预算的结转金额
- 修复结转链条
- 重建结转历史记录
- 处理复杂的结转场景

## 使用方法

### 1. 基本使用

```bash
# 进入docker目录
cd docker

# 给脚本执行权限
chmod +x scripts/budget-rollover-fix.sh

# 运行脚本
sudo bash scripts/budget-rollover-fix.sh
```

### 2. 执行模式选择

运行脚本后，会提示选择执行模式：

```
选择执行模式:
1. 诊断模式 (分析预算结转问题)
2. 修复模式 (修复结转金额和历史记录)
3. 重新计算模式 (重新计算所有结转)
4. 退出
```

### 3. 各模式详细说明

#### 诊断模式 (推荐首先运行)
- **安全性**: 只读操作，不修改数据
- **功能**: 全面分析预算结转状态
- **输出**: 详细的问题报告和修复建议

#### 修复模式
- **安全性**: 会修改数据，建议先备份
- **功能**: 修复已识别的结转问题
- **适用**: 问题明确且范围有限的情况

#### 重新计算模式
- **安全性**: 会大量修改数据，需要确认
- **功能**: 重新计算所有预算结转
- **适用**: 结转数据严重错乱的情况

## 输出示例

### 诊断模式输出
```
🔍 1. 诊断预算结转问题
--------------------------------------------------
找到 15 个启用结转的上月预算

📊 分析预算: 生活费预算 (abc123)
  账本: 张家账本
  用户: 张三
  上月金额: 3000
  上月结转金额: 200
  实际支出: 2800
  应结转金额: 400
  ✅ 找到当月预算: def456
  当月基础金额: 3000
  当月结转金额: 400
  ✅ 结转金额正确

📋 诊断总结:
  检查的预算数量: 15
  发现的问题数量: 3

🚨 发现的问题:
  1. ROLLOVER_AMOUNT_MISMATCH
     预算ID: xyz789
     差异: -150
  2. MISSING_CURRENT_BUDGET
     上月预算ID: uvw012
     应结转金额: 250
```

### 修复模式输出
```
🔧 2. 修复预算结转问题
--------------------------------------------------
✅ 修复预算 xyz789: 250 → 400
✅ 记录结转历史成功: FIXED - 历史ID: hist123, 金额: 400

修复统计: 成功修复 3 个预算，失败 0 个
```

### 重新计算模式输出
```
🔄 3. 重新计算所有预算结转
--------------------------------------------------
找到 45 个启用结转的预算

重新计算预算组: book1_user1_null
  预算 budget1: 基础=3000, 结转=0, 支出=2800, 新结转=200
  预算 budget2: 基础=3000, 结转=200, 支出=3100, 新结转=100

重新计算统计: 处理了 45 个预算
```

## 安全注意事项

### 数据备份
在执行修复或重新计算前，务必备份数据库：

```bash
# 备份数据库
docker exec zhiweijz-postgres pg_dump -U zhiweijz zhiweijz > backup_rollover_$(date +%Y%m%d_%H%M%S).sql
```

### 执行顺序
1. **先运行诊断模式**，了解问题范围
2. **备份数据库**，确保数据安全
3. **选择合适的修复模式**：
   - 问题较少：使用修复模式
   - 问题较多：使用重新计算模式
4. **验证修复结果**，再次运行诊断模式

### 风险评估
- **诊断模式**: 无风险，只读操作
- **修复模式**: 低风险，只修改特定预算
- **重新计算模式**: 中等风险，会修改大量数据

## 常见问题

### Q: 脚本报错"容器未运行"
A: 确保Docker服务已启动：
```bash
docker compose ps
docker compose up -d  # 如果容器未运行
```

### Q: 修复后仍有问题
A: 可能需要重新计算模式：
1. 备份数据库
2. 运行重新计算模式
3. 验证结果

### Q: 结转金额异常大
A: 检查以下可能原因：
- 交易数据异常
- 预算金额设置错误
- 历史结转数据错误

### Q: 债务结转处理
A: 脚本支持以下债务处理：
- 自动债务清零（小额债务）
- 债务上限控制
- 长期债务清理

## 技术原理

### 结转计算公式
```
结转金额 = (基础预算 + 上期结转) - 实际支出
```

### 债务处理逻辑
- **正数结转**: 余额结转到下期
- **负数结转**: 债务结转到下期
- **债务清零**: 小额或长期债务自动清零

### 历史记录结构
- **SURPLUS**: 余额结转记录
- **DEFICIT**: 债务结转记录
- 包含完整的审计信息

## 监控建议

### 定期检查
建议每月运行一次诊断模式：

```bash
# 可以设置cron job
0 3 1 * * cd /path/to/docker && bash scripts/budget-rollover-fix.sh
```

### 日志监控
关注以下日志：
- 结转计算异常
- 债务比例过高
- 历史记录创建失败

## 联系支持

如果遇到脚本无法解决的问题，请提供：
1. 诊断模式的完整输出
2. 相关预算的详细信息
3. 错误日志和堆栈信息
