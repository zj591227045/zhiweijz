# æ•°æ®åº“è¿ç§»é—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

å¦‚æœæ‚¨åœ¨å¯åŠ¨åç«¯å®¹å™¨æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
[MIGRATION] SQLæ‰§è¡Œå¤±è´¥: DO $$ BEGIN ALTER TABLE budgets ADD CONSTRAINT budgets_account_book_id_fkey FOREIGN KEY (account_boo...
[MIGRATION] è¿ç§»å¤±è´¥: insert or update on table "budgets" violates foreign key constraint "budgets_account_book_id_fkey"
```

è¿™æ˜¯ç”±äºæ•°æ®å®Œæ•´æ€§é—®é¢˜å¯¼è‡´çš„å¤–é”®çº¦æŸè¿åé”™è¯¯ã€‚

## è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬æä¾›äº†ä¸‰ç§ä¿®å¤è„šæœ¬ï¼ŒæŒ‰æ¨èç¨‹åº¦æ’åºï¼š

### ğŸš€ æ–¹æ¡ˆä¸€ï¼šå¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šè§£å†³å½“å‰çš„å¤–é”®çº¦æŸé—®é¢˜ï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡

```bash
cd docker
./scripts/quick-fix.sh
```

**ä¿®å¤å†…å®¹**ï¼š
- ä¿®å¤å¤–é”®çº¦æŸé—®é¢˜
- æ¸…ç†æ— æ•ˆæ•°æ®
- æ ‡è®°è¿ç§»ä¸ºå·²å®Œæˆ
- é‡å¯åç«¯å®¹å™¨

**æ‰§è¡Œæ—¶é—´**ï¼šçº¦1-2åˆ†é’Ÿ

### ğŸ”§ æ–¹æ¡ˆäºŒï¼šå®Œæ•´çƒ­ä¿®å¤

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦å®Œæ•´çš„æ•°æ®å®Œæ•´æ€§ä¿®å¤

```bash
cd docker
./scripts/hotfix-migration.sh
```

**ä¿®å¤å†…å®¹**ï¼š
- å®Œæ•´çš„æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å’Œä¿®å¤
- æ¸…ç†é‡å¤æ•°æ®
- æ·»åŠ æ‰€æœ‰å¿…è¦çš„çº¦æŸå’Œç´¢å¼•
- é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯

**æ‰§è¡Œæ—¶é—´**ï¼šçº¦3-5åˆ†é’Ÿ

### ğŸ” æ–¹æ¡ˆä¸‰ï¼šè¯Šæ–­å’Œä¿®å¤

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦è¯¦ç»†äº†è§£é—®é¢˜å¹¶é€æ­¥ä¿®å¤

```bash
cd docker
./scripts/diagnose-migration.sh
```

**åŠŸèƒ½**ï¼š
- ç”Ÿæˆè¯¦ç»†çš„è¯Šæ–­æŠ¥å‘Š
- è‡ªåŠ¨å°è¯•ä¿®å¤
- æä¾›æ•…éšœæ’é™¤å»ºè®®

## ä½¿ç”¨æ­¥éª¤

1. **ç¡®ä¿å®¹å™¨è¿è¡Œ**ï¼š
   ```bash
   docker-compose up -d backend
   ```

2. **é€‰æ‹©åˆé€‚çš„ä¿®å¤è„šæœ¬**ï¼š
   - å¦‚æœåªæ˜¯æƒ³å¿«é€Ÿè§£å†³é—®é¢˜ï¼šä½¿ç”¨ `quick-fix.sh`
   - å¦‚æœéœ€è¦å®Œæ•´ä¿®å¤ï¼šä½¿ç”¨ `hotfix-migration.sh`
   - å¦‚æœéœ€è¦è¯Šæ–­ï¼šä½¿ç”¨ `diagnose-migration.sh`

3. **æ‰§è¡Œä¿®å¤è„šæœ¬**ï¼š
   ```bash
   cd docker
   ./scripts/quick-fix.sh
   ```

4. **æ£€æŸ¥ä¿®å¤ç»“æœ**ï¼š
   ```bash
   docker logs zhiweijz-backend --tail=20
   ```

## éªŒè¯ä¿®å¤

ä¿®å¤å®Œæˆåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
âœ… å¢é‡è¿ç§»å®Œæˆ
âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
ğŸ”§ ç”ŸæˆPrismaå®¢æˆ·ç«¯...
å¯åŠ¨åº”ç”¨æœåŠ¡å™¨...
```

## é¢„é˜²æªæ–½

ä¸ºäº†é¿å…å°†æ¥å‡ºç°ç±»ä¼¼é—®é¢˜ï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨æœ€æ–°çš„Dockeré•œåƒ**ï¼š
   ```bash
   docker pull zj591227045/zhiweijz-backend:latest
   ```

2. **å®šæœŸå¤‡ä»½æ•°æ®åº“**ï¼š
   ```bash
   docker exec zhiweijz-postgres pg_dump -U postgres zhiweijz > backup.sql
   ```

3. **ç›‘æ§è¿ç§»æ—¥å¿—**ï¼š
   ```bash
   docker logs zhiweijz-backend | grep MIGRATION
   ```

## æ•…éšœæ’é™¤

### å¦‚æœä¿®å¤è„šæœ¬å¤±è´¥

1. **æ£€æŸ¥å®¹å™¨çŠ¶æ€**ï¼š
   ```bash
   docker ps | grep zhiweijz
   ```

2. **æŸ¥çœ‹è¯¦ç»†é”™è¯¯**ï¼š
   ```bash
   docker logs zhiweijz-backend --tail=50
   ```

3. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**ï¼š
   ```bash
   docker exec zhiweijz-backend npx prisma db execute --stdin <<< "SELECT 1;"
   ```

### å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨

1. ä¿å­˜å®Œæ•´çš„é”™è¯¯æ—¥å¿—
2. è¿è¡Œè¯Šæ–­è„šæœ¬è·å–è¯¦ç»†æŠ¥å‘Š
3. è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›ï¼š
   - é”™è¯¯æ—¥å¿—
   - è¯Šæ–­æŠ¥å‘Š
   - Dockerç‰ˆæœ¬ä¿¡æ¯
   - ç³»ç»Ÿç¯å¢ƒä¿¡æ¯

## å®‰å…¨è¯´æ˜

âš ï¸ **é‡è¦æé†’**ï¼š

- æ‰€æœ‰ä¿®å¤è„šæœ¬éƒ½è®¾è®¡ä¸º**æ•°æ®å®‰å…¨ä¼˜å…ˆ**
- **ä¸ä¼šæ‰§è¡Œä»»ä½•å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±çš„æ“ä½œ**
- åœ¨ä¿®å¤å‰ä¼šè‡ªåŠ¨å¤‡ä»½å…³é”®æ•°æ®
- å¦‚æœ‰ç–‘é—®ï¼Œè¯·å…ˆè”ç³»æŠ€æœ¯æ”¯æŒ

## è”ç³»æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨ä¿®å¤è„šæœ¬æ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·ï¼š

1. ä¿å­˜å®Œæ•´çš„é”™è¯¯æ—¥å¿—
2. è¿è¡Œ `./scripts/diagnose-migration.sh` è·å–è¯Šæ–­æŠ¥å‘Š
3. è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›ä¸Šè¿°ä¿¡æ¯

---

**æœ€åæ›´æ–°**ï¼š2025-07-29
**ç‰ˆæœ¬**ï¼šv1.0.0
