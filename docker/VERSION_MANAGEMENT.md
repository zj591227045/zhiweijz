# 只为记账 Docker 版本管理

## 🎯 功能概述

启动脚本现在支持自动从 `docker-compose.yml` 文件中读取和解析各个服务的镜像版本，实现智能版本管理。

## 🔧 主要功能

### 1. 自动版本解析
- 从 `docker-compose.yml` 自动解析后端、前端、Nginx镜像版本
- 支持任意版本标签格式（latest、v1.0.0、dev等）
- 解析结果会在启动前显示供用户确认

### 2. 多配置文件支持
- **完整配置** (`docker-compose.yml`) - 默认配置，包含完整功能
- **简化配置** (`docker-compose.simple.yml`) - 使用通用镜像，兼容性更好

### 3. 版本确认机制
- 启动前显示所有解析出的镜像版本
- 用户可以确认或取消部署
- 避免意外使用错误版本

## 📝 使用方法

### 基本使用
```bash
cd docker
./start.sh
```

### 指定镜像版本
编辑 `docker-compose.yml` 文件：

```yaml
services:
  backend:
    image: zj591227045/zhiweijz-backend:v1.2.0
    
  frontend:
    image: zj591227045/zhiweijz-frontend:v1.1.5
    
  nginx:
    image: zj591227045/zhiweijz-nginx:v2.0.1
```

然后运行启动脚本，它会自动检测并使用指定版本。

## 🔍 版本解析示例

启动时会显示类似以下信息：

```
[INFO] 镜像版本解析完成:
[INFO]   后端镜像: zj591227045/zhiweijz-backend:v1.2.0
[INFO]   前端镜像: zj591227045/zhiweijz-frontend:v1.1.5
[INFO]   Nginx镜像: zj591227045/zhiweijz-nginx:v2.0.1

是否使用以上镜像版本继续部署？(Y/n):
```

## 🛠️ 技术实现

### 解析算法
使用 AWK 脚本解析 YAML 文件：
1. 识别服务名称（顶级服务定义）
2. 在对应服务块中查找 `image:` 行
3. 提取镜像名称和版本标签

### 容错处理
- 解析失败时显示详细错误信息
- 支持镜像名称标准化（自动添加 `:latest` 标签）
- 前端镜像问题不阻止整体部署流程

## 📋 版本管理最佳实践

1. **使用语义化版本号**: `v1.0.0`, `v1.1.0`, `v2.0.0`
2. **测试环境使用特定版本**: 避免使用 `latest` 标签
3. **生产环境锁定版本**: 确保部署的一致性
4. **定期更新版本**: 及时获取新功能和安全修复

## 🔄 版本回滚

如需回滚到之前版本：
1. 修改 `docker-compose.yml` 中的镜像标签
2. 运行 `./start.sh` 重新部署
3. 脚本会自动拉取指定版本并重新启动服务

## 🚨 注意事项

- 确保指定的镜像版本在 Docker Hub 上存在
- 前端镜像需要支持 3001 端口（新版本要求）
- 版本不匹配可能导致服务间通信问题
- 建议在测试环境验证版本兼容性后再部署到生产环境
