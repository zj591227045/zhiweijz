# 仪表盘日志优化方案

## 问题分析

### 1. 重复API请求问题
- `/system-config/global-ai` 被调用3次
- `/auth/check` 和 `/auth/token-status` 在多个组件中重复调用
- 账本数据和统计数据在页面刷新时重复获取

### 2. 冗余调试信息
- API请求详情在每次请求时都输出
- 图片加载状态过于详细
- 组件状态变化日志过多

### 3. 日志级别混乱
- 生产级别的信息和调试信息混在一起
- 缺乏统一的日志管理策略

## 优化方案

### 第一步：API请求去重和缓存

#### 1.1 创建请求缓存管理器
```typescript
// apps/web/src/lib/request-cache.ts
class RequestCache {
  private cache = new Map<string, Promise<any>>();
  private results = new Map<string, { data: any; timestamp: number; ttl: number }>();

  async get<T>(key: string, fetcher: () => Promise<T>, ttl = 5000): Promise<T> {
    // 检查缓存
    const cached = this.results.get(key);
    if (cached && Date.now() - cached.timestamp < cached.ttl) {
      return cached.data;
    }

    // 检查正在进行的请求
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    // 发起新请求
    const promise = fetcher().then(data => {
      this.results.set(key, { data, timestamp: Date.now(), ttl });
      this.cache.delete(key);
      return data;
    }).catch(error => {
      this.cache.delete(key);
      throw error;
    });

    this.cache.set(key, promise);
    return promise;
  }
}
```

#### 1.2 修改API客户端，添加请求去重
```typescript
// 在 api-client.ts 中添加
const requestCache = new RequestCache();

// 为GET请求添加缓存
async get<T = any>(url: string, config?: AxiosRequestConfig & { useCache?: boolean }): Promise<T> {
  if (config?.useCache !== false && !config?.params) {
    return requestCache.get(url, () => this.instance.get(url, config));
  }
  return this.instance.get(url, config);
}
```

### 第二步：日志分级优化

#### 2.1 替换API请求日志
```typescript
// 在 api-client.ts 中
import { createLogger } from './logger';
const apiLogger = createLogger('API');

// 替换 console.log 为分级日志
this.instance.interceptors.request.use((config) => {
  const baseURL = getApiBaseUrl();
  config.baseURL = baseURL;
  
  // 使用 debug 级别记录请求详情
  apiLogger.debug('请求详情', {
    url: config.url,
    method: config.method?.toUpperCase(),
    fullUrl: baseURL + config.url
  });
  
  // ... 其他逻辑
});
```

#### 2.2 优化图片加载日志
```typescript
// 在 enhanced-authenticated-image.tsx 中
import { createLogger } from '@/lib/logger';
const imageLogger = createLogger('Image');

// 替换详细日志为简化版本
const handleImageLoad = () => {
  imageLogger.debug('图片加载成功', { url: url.substring(0, 50) + '...' });
  // 移除详细的尺寸信息日志
};

const handleImageError = (error: any) => {
  imageLogger.warn('图片加载失败', { 
    url: url.substring(0, 50) + '...',
    retry: currentRetry,
    maxRetry: retryCount 
  });
};
```

### 第三步：组件状态日志优化

#### 3.1 仪表盘组件日志简化
```typescript
// 在相关组件中
import { createLogger } from '@/lib/logger';
const dashboardLogger = createLogger('Dashboard');

// 替换频繁的状态日志
useEffect(() => {
  if (isAuthenticated && user) {
    dashboardLogger.info('用户已登录，初始化仪表盘');
    // 移除详细的状态对象日志
  }
}, [isAuthenticated, user]);
```

#### 3.2 移动端导航日志优化
```typescript
// 在 mobile-navigation-initializer.tsx 中
const navLogger = createLogger('Navigation');

// 简化路径变化日志
const handlePathChange = (path: string) => {
  navLogger.debug('路径变化', { path });
  // 移除详细的状态对象
};
```

### 第四步：迁移到React Query（正确方案）

#### 4.1 创建系统配置React Query hooks
```typescript
// apps/web/src/hooks/queries/useSystemConfigQueries.ts
export function useGlobalAIConfig() {
  return useQuery({
    queryKey: ['systemConfig', 'globalAI'],
    queryFn: () => systemConfigApi.getGlobalAIConfig(),
    staleTime: 5 * 60 * 1000, // 5分钟缓存
    retry: 2,
  });
}

export function useSystemFeatures() {
  return useQuery({
    queryKey: ['systemConfig', 'features'],
    queryFn: async () => {
      const response = await fetch(`${getApiBaseUrl()}/system/features`);
      return response.json();
    },
    staleTime: 5 * 60 * 1000,
    placeholderData: {
      membershipEnabled: true,
      accountingPointsEnabled: true,
    },
  });
}
```

#### 4.2 更新现有hooks使用React Query
```typescript
// apps/web/src/hooks/useSystemConfig.ts
export function useSystemConfig() {
  const { data: config, isLoading: loading, error: queryError } = useSystemFeatures();
  
  return { 
    config: config || { membershipEnabled: false, accountingPointsEnabled: false }, 
    loading, 
    error: queryError?.message || null 
  };
}
```

### 第五步：环境配置优化

#### 5.1 生产环境日志配置
```typescript
// 在 logger-config.ts 中添加环境检测
const getDefaultLogLevel = (): LogLevel => {
  if (process.env.NODE_ENV === 'production') {
    // 生产环境只显示警告和错误
    return LogLevel.WARN;
  }
  
  // 开发环境显示所有日志
  return LogLevel.DEBUG;
};
```

#### 5.2 URL参数控制
```typescript
// 支持通过URL参数临时调整日志级别
// ?debug=true 或 ?logLevel=DEBUG
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('debug') === 'true') {
  loggerConfig.setGlobalLevel(LogLevel.DEBUG);
}
```

## 实施计划

### ✅ 阶段一：基础优化（已完成）
1. ✅ 修改API客户端日志级别
2. ✅ 简化图片加载日志  
3. ✅ 移除冗余的组件状态日志
4. ✅ 创建系统配置React Query hooks

### ✅ 阶段二：核心数据迁移（已完成）
1. ✅ 仪表盘数据获取迁移到React Query
2. ✅ 认证状态检查优化
3. ✅ 账本数据获取统一缓存
4. ✅ 创建兼容层保持接口不变

### 🔄 阶段三：验证和优化（进行中）
1. 🔄 测试迁移后的性能提升
2. ⏳ 监控日志输出减少情况
3. ⏳ 验证API请求去重效果

## 已完成的优化成果

### 1. 日志系统优化 ✅
- **API请求日志**：从详细输出改为debug级别
- **图片加载日志**：简化为关键信息
- **系统配置日志**：移除冗余状态输出
- **分级控制**：可通过浏览器控制台动态调整

### 2. 数据获取优化 ✅
- **仪表盘数据**：迁移到React Query，自动缓存5分钟
- **系统配置**：统一缓存，避免重复请求
- **认证检查**：使用React Query管理token状态
- **账本数据**：统一缓存策略，减少重复获取

### 3. 性能提升预期
- **日志数量减少80%** - 通过分级控制
- **API请求减少60%** - 通过React Query缓存
- **页面加载提升** - 消除重复请求
- **开发效率提升** - 清晰的日志分级

## 配置示例

开发环境下可以通过以下方式控制日志：

```javascript
// 浏览器控制台
setLogLevel('INFO');  // 只显示INFO及以上级别
setModuleLogLevel('API', 'DEBUG');  // API模块显示DEBUG
getLoggerDebugInfo();  // 查看当前配置
```