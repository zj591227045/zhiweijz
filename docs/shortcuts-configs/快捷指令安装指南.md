# 快捷指令安装指南

## 🚀 方法一：一键安装（推荐）

### 智能图片记账快捷指令
基于X-Callback URL技术，支持完整质量图片上传，无URL长度限制：

**🔗 安装链接：** `shortcuts://import-shortcut?url=https://jz-dev.jacksonz.cn:4443/shortcuts/smart-image-accounting.shortcut`

### 📱 安装步骤

1. **在iPhone上点击上述链接**
2. **选择"获取快捷指令"**
3. **点击"添加快捷指令"**
4. **完成安装**

### 🔧 技术原理

本快捷指令使用了Apple官方支持的**X-Callback URL**技术：
- 📖 **官方文档**：[Apple Support - Use x-callback-url](https://support.apple.com/guide/shortcuts/use-x-callback-url-apdcd7f20a6f/ios)
- 🔗 **X-Callback URL规范**：[x-callback-url.com](https://x-callback-url.com/)
- ✅ **无需剪贴板权限**：避免iOS权限限制
- 🔄 **自动数据传递**：通过`x-success`参数返回token数据

## 方法二：手动创建

如果无法使用安装链接，可以按照以下步骤手动创建：

### 图片记账快捷指令创建步骤

1. **打开快捷指令App**
   - 在iPhone上打开"快捷指令"应用

2. **创建新快捷指令**
   - 点击右上角"+"号
   - 点击"添加操作"

3. **添加动作序列**
   
   **步骤1：截取屏幕**
   - 搜索"截取屏幕"
   - 添加"截取屏幕"动作
   
   **步骤2：调整图像大小（可选）**
   - 搜索"调整图像大小"
   - 添加"调整图像大小"动作
   - 设置宽度：1080像素
   - 设置格式：JPEG
   - 设置质量：80%
   
   **步骤3：大幅压缩图片（关键）**
   - 搜索"调整图像大小"
   - 添加"调整图像大小"动作
   - 设置宽度：**600像素**（关键：大幅减小尺寸）
   - 保持宽高比：开启

   **步骤4：转换为Base64**
   - 搜索"Base64编码"
   - 添加"Base64编码"动作
   - 设置换行：无

   **步骤5：打开URL**
   - 搜索"打开URL"
   - 添加"打开URL"动作
   - 在URL字段中输入：
     ```
     zhiweijz://smart-accounting?type=image&data=
     ```
   - 然后点击URL字段末尾，选择"Base64编码文本"变量
   - 最后在末尾添加：
     ```
     &source=shortcuts
     ```

   **注意：** 通过大幅压缩图片（600px宽度）来减小Base64数据量，避免URL长度限制

## 🚀 X-Callback URL方案：对象存储上传（当前实现）

### 快捷指令工作流程

我们的快捷指令使用以下技术流程：

1. **截取屏幕** → 获取当前屏幕截图
2. **X-Callback URL调用** → 获取上传token
3. **对象存储上传** → 上传图片到云存储
4. **AI识别调用** → 传递图片URL进行智能记账

### 手动创建步骤（如果一键安装失败）

1. **打开快捷指令App**
2. **创建新快捷指令**，命名为"智能图片记账"
3. **添加以下动作**：

   **步骤1：截取屏幕**
   - 搜索并添加"截取屏幕"动作

   **步骤2：获取上传Token（关键）**
   - 搜索并添加"**打开X-Callback URL**"动作
   - **X-Callback URL**：`zhiweijz://smart-accounting?type=get-token`
   - **X-Success**：留空（系统自动处理）
   - **X-Cancel**：留空
   - **X-Error**：留空

   > ⚠️ **重要**：必须使用"打开X-Callback URL"动作，不是"打开URL"动作

   **步骤3：提取Token**
   - 搜索并添加"获取词典值"动作
   - **词典**：选择上一步的"结果"
   - **获取**：`token`
   - **设置变量**：命名为"UploadToken"

   **步骤4：提取上传URL**
   - 搜索并添加"获取词典值"动作
   - **词典**：选择步骤2的"结果"
   - **获取**：`uploadUrl`
   - **设置变量**：命名为"UploadURL"

   **步骤5：上传图片到对象存储**
   - 搜索并添加"获取URL内容"动作
   - **URL**：选择"UploadURL"变量
   - **方法**：POST
   - **请求体**：表单
   - **表单字段**：
     - 名称：`image`
     - 值：选择步骤1的"截图"
   - **标头**：
     - 名称：`Authorization`
     - 值：`Bearer ` + "UploadToken"变量

   **步骤6：提取图片URL**
   - 搜索并添加"获取词典值"动作
   - **词典**：选择步骤5的"URL内容"
   - **获取**：`imageUrl`

   **步骤7：调用AI识别**
   - 搜索并添加"打开URL"动作
   - **URL**：`zhiweijz://smart-accounting?type=image&imageUrl=` + 步骤6的图片URL + `&source=shortcuts`

4. **保存快捷指令**
   - 点击"完成"
   - 命名为"智能图片记账"

### 🔧 X-Callback URL技术细节

根据Apple官方文档，X-Callback URL支持以下参数：

- **x-success**：成功时的回调URL，包含`result`参数
- **x-cancel**：用户取消时的回调URL
- **x-error**：出错时的回调URL，包含`errorMessage`参数

我们的实现：
```
zhiweijz://smart-accounting?type=get-token
```

返回数据格式：
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "uploadUrl": "https://storage.example.com/upload",
  "expiresIn": 3600
}
```

## 方法三：扫码安装

我们也可以生成二维码供用户扫描安装：

### 二维码内容
```
shortcuts://import-shortcut?url=https://你的域名/shortcuts/只为记账-图片记账.shortcut
```

## 配置轻点背面触发

安装完快捷指令后，需要设置轻点背面触发：

1. **打开设置**
   - 设置 > 辅助功能

2. **找到触控设置**
   - 辅助功能 > 触控

3. **配置轻点背面**
   - 触控 > 轻点背面
   - 选择"轻点两下"或"轻点三下"
   - 在快捷指令列表中选择"只为记账-图片记账"

## 测试快捷指令

1. **确保应用已登录**
   - 打开只为记账App
   - 确保已登录并选择了账本

2. **测试截图记账**
   - 打开任意支付页面（如微信支付记录）
   - 轻敲iPhone背面
   - 等待自动截图和记账处理

## 故障排除

### 常见问题

1. **轻点背面没有反应**
   - 检查设置 > 辅助功能 > 触控 > 轻点背面
   - 确保选择了正确的快捷指令
   - 尝试重新设置

2. **快捷指令无法运行**
   - 检查快捷指令是否正确创建
   - 确保URL格式正确
   - 检查网络连接

3. **X-Callback URL调用失败**
   - 确保使用"打开X-Callback URL"动作，不是"打开URL"
   - 检查URL格式：`zhiweijz://smart-accounting?type=get-token`
   - 确保App已安装并可以处理自定义URL Scheme

4. **Token获取失败**
   - 确保已登录只为记账App
   - 检查网络连接
   - 查看App是否显示错误提示

5. **图片上传失败**
   - 检查token是否有效
   - 确保网络连接稳定
   - 检查对象存储服务状态

6. **记账失败**
   - 确保已登录只为记账App
   - 检查是否选择了账本
   - 确保图片URL有效

### 支持的场景

- ✅ 微信支付记录
- ✅ 支付宝付款页面  
- ✅ 淘宝/京东订单详情
- ✅ 美团/饿了么外卖订单
- ✅ 银行转账记录
- ✅ 发票和收据
- ✅ POS机小票

### 最佳实践

- 选择信息完整的页面进行截图
- 避免截图时有弹窗遮挡
- 确保金额和商家信息清晰可见
- 在网络良好的环境下使用
