# 优化版快捷指令配置指南

## 概述

优化版快捷指令实现了智能token管理，避免每次都重新获取token，提升用户体验。

## 主要优化点

1. **Token有效期延长至72小时**
2. **智能token检查机制**：先检查现有token是否有效，无效时才获取新token
3. **持久化存储**：使用快捷指令的数据存储功能保存token和uploadUrl
4. **减少跳转次数**：大部分情况下只需要一次跳转

## 快捷指令配置步骤

### 1. 创建快捷指令

1. 打开快捷指令App
2. 创建新快捷指令，命名为"只为记账-截图记账"
3. 按以下步骤添加动作：

### 2. 步骤1：截取屏幕

- 搜索并添加"截取屏幕"动作

### 3. 步骤2：获取存储的Token和URL

- 搜索并添加"获取我的快捷指令"动作
- 选择"获取值"
- 键：`uploadToken`
- 设置变量：命名为"StoredToken"

- 再添加一个"获取我的快捷指令"动作
- 选择"获取值"  
- 键：`uploadUrl`
- 设置变量：命名为"StoredUploadUrl"

- 再添加一个"获取我的快捷指令"动作
- 选择"获取值"
- 键：`checkTokenUrl`
- 设置变量：命名为"StoredCheckUrl"

### 4. 步骤3：检查Token是否存在

- 搜索并添加"如果"动作
- 条件：StoredToken "有任何值"

### 5. 步骤4：检查Token有效性（在"如果"内部）

- 搜索并添加"获取URL内容"动作
- URL：选择"StoredCheckUrl"变量
- 方法：POST
- 请求体：JSON
- JSON内容：
```json
{
  "token": "StoredToken变量"
}
```

- 设置变量：命名为"TokenCheckResult"

### 6. 步骤5：解析检查结果

- 搜索并添加"获取词典值"动作
- 词典：选择"TokenCheckResult"
- 获取：`valid`
- 设置变量：命名为"IsTokenValid"

> **注意**：API返回的是快捷指令兼容的词典格式，`valid`字段的值为字符串`"true"`或`"false"`，而不是布尔值。

### 7. 步骤6：根据Token有效性决定操作

- 搜索并添加"如果"动作（嵌套在第一个如果内）
- 条件：IsTokenValid "等于" "true"

> **重要**：这里要比较的是字符串`"true"`，不是布尔值`true`

#### 7.1 Token有效时（在嵌套"如果"内部）

- 搜索并添加"设置变量"动作
- 变量名：`FinalToken`
- 值：选择"StoredToken"

- 搜索并添加"设置变量"动作
- 变量名：`FinalUploadUrl`
- 值：选择"StoredUploadUrl"

#### 7.2 Token无效时（在嵌套"否则"内部）

- 搜索并添加"打开X-Callback URL"动作
- X-Callback URL：`zhiweijz://smart-accounting?type=get-token`
- 设置变量：命名为"NewTokenResult"

- 搜索并添加"获取词典值"动作
- 词典：选择"NewTokenResult"
- 获取：`token`
- 设置变量：命名为"NewToken"

- 搜索并添加"获取词典值"动作
- 词典：选择"NewTokenResult"
- 获取：`uploadUrl`
- 设置变量：命名为"NewUploadUrl"

- 搜索并添加"获取词典值"动作
- 词典：选择"NewTokenResult"
- 获取：`checkTokenUrl`
- 设置变量：命名为"NewCheckUrl"

- 搜索并添加"设置我的快捷指令"动作
- 键：`uploadToken`
- 值：选择"NewToken"

- 搜索并添加"设置我的快捷指令"动作
- 键：`uploadUrl`
- 值：选择"NewUploadUrl"

- 搜索并添加"设置我的快捷指令"动作
- 键：`checkTokenUrl`
- 值：选择"NewCheckUrl"

- 搜索并添加"设置变量"动作
- 变量名：`FinalToken`
- 值：选择"NewToken"

- 搜索并添加"设置变量"动作
- 变量名：`FinalUploadUrl`
- 值：选择"NewUploadUrl"

### 8. 步骤7：首次使用处理（在最外层"否则"内部）

当没有存储的Token时：

- 搜索并添加"打开X-Callback URL"动作
- X-Callback URL：`zhiweijz://smart-accounting?type=get-token`
- 设置变量：命名为"FirstTokenResult"

- 搜索并添加"获取词典值"动作
- 词典：选择"FirstTokenResult"
- 获取：`token`
- 设置变量：命名为"FirstToken"

- 搜索并添加"获取词典值"动作
- 词典：选择"FirstTokenResult"
- 获取：`uploadUrl`
- 设置变量：命名为"FirstUploadUrl"

- 搜索并添加"获取词典值"动作
- 词典：选择"FirstTokenResult"
- 获取：`checkTokenUrl`
- 设置变量：命名为"FirstCheckUrl"

- 搜索并添加"设置我的快捷指令"动作
- 键：`uploadToken`
- 值：选择"FirstToken"

- 搜索并添加"设置我的快捷指令"动作
- 键：`uploadUrl`
- 值：选择"FirstUploadUrl"

- 搜索并添加"设置我的快捷指令"动作
- 键：`checkTokenUrl`
- 值：选择"FirstCheckUrl"

- 搜索并添加"设置变量"动作
- 变量名：`FinalToken`
- 值：选择"FirstToken"

- 搜索并添加"设置变量"动作
- 变量名：`FinalUploadUrl`
- 值：选择"FirstUploadUrl"

### 9. 步骤8：上传图片

- 搜索并添加"获取URL内容"动作
- URL：选择"FinalUploadUrl"变量
- 方法：POST
- 请求体：表单
- 表单字段：
  - 名称：`image`
  - 值：选择步骤1的"截图"
- 标头：
  - 名称：`Authorization`
  - 值：`Bearer ` + "FinalToken"变量

### 10. 步骤9：处理上传结果

- 搜索并添加"获取词典值"动作
- 词典：选择上一步的"URL内容"
- 获取：`imageUrl`
- 设置变量：命名为"ImageUrl"

### 11. 步骤10：调用图片记账

- 搜索并添加"打开X-Callback URL"动作
- X-Callback URL：`zhiweijz://smart-accounting?type=image-accounting&imageUrl=` + "ImageUrl"变量

## 优势说明

1. **首次使用**：需要1次跳转获取token
2. **后续使用**：
   - Token有效时：0次跳转，直接上传
   - Token过期时：1次跳转获取新token
3. **Token有效期**：72小时，大大减少重新获取的频率
4. **智能检查**：自动检查token有效性，无需手动判断

## 注意事项

1. 确保使用"打开X-Callback URL"而不是"打开URL"
2. 变量名称要保持一致
3. 嵌套的"如果"语句要正确配置
4. 首次使用时会进行初始化设置

## API返回格式说明

### 获取Token接口返回格式
```json
{
  "success": true,
  "token": "eyJ1c2VySWQ...",
  "uploadUrl": "https://api.domain.com/api/upload/shortcuts",
  "checkTokenUrl": "https://api.domain.com/api/ai/shortcuts/check-token",
  "expiresIn": 259200,
  "expiresAt": 1753780703674
}
```

### 检查Token接口返回格式（快捷指令兼容的词典格式）

**Token有效时：**
```json
{
  "valid": "true",
  "remainingTime": "259199960",
  "remainingHours": "71",
  "message": "Token有效，剩余71小时"
}
```

**Token无效时：**
```json
{
  "valid": "false",
  "message": "Token已过期或无效"
}
```

> **重要**：所有返回值都是字符串格式，便于快捷指令直接使用。

## 故障排除

如果遇到问题：
1. 检查变量名是否正确
2. 确认"如果"语句的嵌套结构
3. 验证X-Callback URL格式
4. **注意比较条件**：使用字符串`"true"`而不是布尔值`true`
5. 清除存储的数据重新初始化：删除快捷指令中存储的`uploadToken`、`uploadUrl`、`checkTokenUrl`键值
