# 统一定时任务调度器

## 概述

统一定时任务调度器是一个集中管理所有定时任务的系统，取代了之前分散在各处的独立定时任务实现。

## 架构设计

### 核心组件

1. **内部任务注册表** (`internal-task-registry.ts`)
   - 单例模式，全局唯一
   - 管理所有内部任务的注册和执行
   - 提供统一的任务执行接口

2. **计划任务管理服务** (`scheduled-task.admin.service.ts`)
   - 支持内部任务 (`scriptType: 'internal'`) 和外部脚本 (`shell/sql/node`)
   - 基于数据库配置的动态任务调度
   - 完整的执行日志和错误追踪

3. **任务注册模块** (`register-internal-tasks.ts`)
   - 在服务器启动时注册所有内部任务
   - 将现有的独立任务统一注册到系统中

### 已注册的内部任务

| 任务Key | 任务名称 | 描述 | 建议Cron表达式 |
|---------|---------|------|---------------|
| `user-deletion-check` | 用户注销请求处理 | 检查并处理过期的用户注销请求 | `0 0 * * *` (每天0点) |
| `membership-expiry-check` | 会员到期检查 | 检查并处理到期会员 | `30 * * * *` (每小时30分) |
| `wechat-media-cleanup` | 微信媒体文件清理 | 清理超过1小时的临时文件 | `0 * * * *` (每小时) |
| `data-aggregation-manual` | 数据聚合 | 聚合API调用和访问日志数据 | `0 * * * *` (每小时) |
| `storage-temp-files-cleanup` | 对象存储临时文件清理 | 清理过期的临时文件 | `0 2 * * *` (每天2点) |
| `budget-rollover-and-creation` | 预算结转和创建 | 处理预算结转和创建新月份预算 | `0 2 1 * *` (每月1号2点) |

## 使用方式

### 方式一：传统模式（默认）

不设置环境变量或设置 `USE_UNIFIED_SCHEDULER=false`，系统将使用传统的独立任务调度器。

**特点：**
- 每个任务独立运行
- 无法统一管理和监控
- 修改任务时间需要改代码并重启服务

### 方式二：统一调度器模式（推荐）

设置环境变量 `USE_UNIFIED_SCHEDULER=true`，系统将使用统一计划任务调度器。

**特点：**
- 所有任务统一管理
- 可通过管理界面查看执行日志
- 可动态启用/禁用任务
- 可手动触发任务执行
- 支持任务执行失败重试

### 迁移步骤

#### 1. 运行数据库迁移

```bash
cd server
npm run migrate:upgrade
```

这将在数据库中创建6个内部任务记录（默认禁用状态）。

#### 2. 设置环境变量

在 `.env` 文件中添加：

```bash
USE_UNIFIED_SCHEDULER=true
```

#### 3. 重启服务器

```bash
npm run dev  # 开发环境
# 或
npm run start  # 生产环境
```

#### 4. 在管理界面启用任务

访问管理后台 -> 计划任务管理，逐个启用需要的任务。

**建议启用顺序：**
1. 先启用低频任务（如预算结转）
2. 观察执行日志，确认无误
3. 再启用高频任务（如会员到期检查）

#### 5. 验证任务执行

- 查看执行日志，确认任务正常运行
- 对比新旧系统的执行结果
- 确认无重复执行

#### 6. 清理旧代码（可选）

确认统一调度器运行稳定后，可以删除以下文件：
- `server/src/tasks/membership-expiry-check.task.ts`
- `server/src/tasks/wechat-media-cleanup.task.ts`
- `server/src/services/user-deletion.service.ts` 中的 `startScheduledDeletion` 方法

## 管理界面操作

### 查看任务列表

访问：`/admin/scheduled-tasks`

可以看到所有已配置的计划任务，包括：
- 任务名称和描述
- 脚本类型（internal/shell/sql/node）
- Cron表达式
- 启用状态
- 最后执行时间

### 手动执行任务

点击任务详情页的"立即执行"按钮，可以手动触发任务执行。

### 查看执行日志

每次任务执行都会记录：
- 开始时间和结束时间
- 执行时长
- 执行状态（成功/失败）
- 标准输出和错误输出
- 触发方式（定时/手动）

### 启用/禁用任务

可以随时启用或禁用任务，无需重启服务器。

## 添加新的内部任务

### 1. 在 `register-internal-tasks.ts` 中注册

```typescript
internalTaskRegistry.register({
  key: 'my-new-task',
  name: '我的新任务',
  description: '任务描述',
  suggestedCron: '0 0 * * *',
  execute: async () => {
    // 任务执行逻辑
    console.log('执行我的新任务');
  }
});
```

### 2. 在数据库中创建任务记录

通过管理界面或SQL插入：

```sql
INSERT INTO scheduled_tasks (
  id, name, description, script_type, script_path, 
  cron_expression, is_enabled
) VALUES (
  gen_random_uuid(),
  '我的新任务',
  '任务描述',
  'internal',
  'my-new-task',
  '0 0 * * *',
  false
);
```

### 3. 重启服务器

重启后新任务将被注册，可在管理界面启用。

## 添加外部脚本任务

### 1. 创建脚本文件

在项目目录下创建脚本文件，例如：
- Shell脚本：`scripts/my-task.sh`
- SQL脚本：`scripts/my-task.sql`
- Node脚本：`scripts/my-task.js`

### 2. 通过管理界面创建任务

访问管理后台 -> 计划任务管理 -> 创建任务

填写：
- 任务名称
- 任务描述
- 脚本类型（shell/sql/node）
- 脚本路径（相对于项目根目录）
- Cron表达式
- 是否启用

## 故障排查

### 任务未执行

1. 检查任务是否启用
2. 检查Cron表达式是否正确
3. 查看服务器日志，确认任务是否被调度
4. 查看执行日志，确认是否有错误

### 任务执行失败

1. 查看执行日志中的错误信息
2. 对于内部任务，检查服务依赖是否正常
3. 对于外部脚本，检查脚本文件是否存在
4. 手动执行任务，观察详细错误

### 任务重复执行

1. 确认只启用了一种调度模式（统一调度器或传统模式）
2. 检查是否有多个相同的任务记录
3. 查看执行日志，确认触发来源

## 性能优化

### 避免任务冲突

- 错开高频任务的执行时间
- 例如：会员检查在每小时30分，数据聚合在每小时0分

### 控制任务执行时长

- 对于长时间运行的任务，考虑分批处理
- 设置合理的超时时间
- 避免在高峰期执行重任务

### 监控任务性能

- 定期查看执行日志
- 关注任务执行时长趋势
- 及时优化慢任务

## 最佳实践

1. **渐进式迁移**：不要一次性启用所有任务，逐个验证
2. **保留日志**：执行日志保留至少30天，便于问题追溯
3. **监控告警**：对关键任务设置执行失败告警
4. **定期审查**：定期检查任务执行情况，优化调度策略
5. **文档更新**：添加新任务时及时更新文档

## 未来规划

- [ ] 支持任务依赖关系（任务A完成后执行任务B）
- [ ] 支持任务执行失败自动重试
- [ ] 支持任务执行结果通知（邮件/webhook）
- [ ] 支持任务执行统计和可视化
- [ ] 支持分布式任务调度（多实例环境）

