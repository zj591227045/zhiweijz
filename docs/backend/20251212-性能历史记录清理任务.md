# æ€§èƒ½å†å²è®°å½•æ¸…ç†ä»»åŠ¡

## èƒŒæ™¯

ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¸­ï¼Œ`system_performance_history` è¡¨çš„å†å²è®°å½•å æ®äº† 90% çš„å­˜å‚¨ç©ºé—´ï¼Œä¸¥é‡å½±å“ï¼š
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- å¤‡ä»½æ•ˆç‡å’Œå­˜å‚¨æˆæœ¬
- æ•´ä½“ç³»ç»Ÿå“åº”é€Ÿåº¦

## è§£å†³æ–¹æ¡ˆ

åœ¨ç»Ÿä¸€è®¡åˆ’ä»»åŠ¡ç®¡ç†ç³»ç»Ÿä¸­æ·»åŠ "æ€§èƒ½å†å²è®°å½•æ¸…ç†"å†…éƒ¨ä»»åŠ¡ï¼Œæ¯å¤©è‡ªåŠ¨æ¸…ç† 30 å¤©ä¹‹å‰çš„å†å²æ•°æ®ã€‚

## å®ç°ç»†èŠ‚

### 1. å†…éƒ¨ä»»åŠ¡æ³¨å†Œ

åœ¨ `server/src/admin/services/register-internal-tasks.ts` ä¸­æ·»åŠ æ–°ä»»åŠ¡ï¼š

```typescript
// 11. æ€§èƒ½å†å²è®°å½•æ¸…ç†ä»»åŠ¡
internalTaskRegistry.register({
  key: 'performance-history-cleanup',
  name: 'æ€§èƒ½å†å²è®°å½•æ¸…ç†',
  description: 'æ¸…ç†30å¤©ä¹‹å‰çš„æ€§èƒ½å†å²æ•°æ®ï¼Œé‡Šæ”¾æ•°æ®åº“ç©ºé—´',
  suggestedCron: '0 1 * * *', // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
  execute: async () => {
    console.log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç†æ€§èƒ½å†å²è®°å½•...');
    const { performanceMonitoringService } = await import('../../services/performance-monitoring.service');
    const deletedCount = await performanceMonitoringService.cleanupOldData();
    console.log(`âœ… æ€§èƒ½å†å²è®°å½•æ¸…ç†å®Œæˆï¼Œå·²åˆ é™¤ ${deletedCount} æ¡è®°å½•`);
  }
});
```

### 2. æ•°æ®åº“è¿ç§»

åˆ›å»ºè¿ç§»æ–‡ä»¶ `server/migrations/incremental/add-performance-history-cleanup-task.sql`ï¼Œåœ¨æ•°æ®åº“ä¸­æ·»åŠ ä»»åŠ¡è®°å½•ã€‚

### 3. å¤ç”¨ç°æœ‰é€»è¾‘

ç›´æ¥è°ƒç”¨ `PerformanceMonitoringService` ä¸­å·²æœ‰çš„ `cleanupOldData()` æ–¹æ³•ï¼š

```typescript
async cleanupOldData() {
  try {
    const result = await prisma.$executeRaw`
      DELETE FROM system_performance_history
      WHERE recorded_at < NOW() - INTERVAL '${this.dataRetentionDays} days'
    `;
    console.log(`æ¸…ç†äº† ${result} æ¡è¿‡æœŸæ€§èƒ½æ•°æ®`);
    return result;
  } catch (error) {
    console.error('æ¸…ç†è¿‡æœŸæ€§èƒ½æ•°æ®å¤±è´¥:', error);
    return 0;
  }
}
```

## ä»»åŠ¡é…ç½®

- **ä»»åŠ¡ Key**: `performance-history-cleanup`
- **ä»»åŠ¡åç§°**: æ€§èƒ½å†å²è®°å½•æ¸…ç†
- **Cron è¡¨è¾¾å¼**: `0 1 * * *` (æ¯å¤©å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œ)
- **æ•°æ®ä¿ç•™æœŸ**: 30 å¤©ï¼ˆå¯åœ¨ç³»ç»Ÿé…ç½® `performance_data_retention_days` ä¸­è°ƒæ•´ï¼‰
- **é»˜è®¤çŠ¶æ€**: å·²å¯ç”¨

## éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è¿ç§»ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

```bash
# è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
node server/migrations/migration-manager.js migrate

# æˆ–æŒ‡å®šå‡çº§åˆ° 1.9.1 ç‰ˆæœ¬
node server/migrations/migration-manager.js migrate 1.9.1
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œ SQL æ–‡ä»¶

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨æˆ–ä½¿ç”¨ psql è¿æ¥
psql -h localhost -U postgres -d zhiweijz -f server/migrations/incremental/add-performance-history-cleanup-task.sql
```

### é‡å¯åç«¯æœåŠ¡

```bash
# Docker ç¯å¢ƒ
docker-compose restart backend

# æˆ–æœ¬åœ°å¼€å‘ç¯å¢ƒ
npm run dev
```

### 3. éªŒè¯ä»»åŠ¡å·²åŠ è½½

æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[å†…éƒ¨ä»»åŠ¡æ³¨å†Œ] æˆåŠŸæ³¨å†Œ 11 ä¸ªå†…éƒ¨ä»»åŠ¡
[è®¡åˆ’ä»»åŠ¡æœåŠ¡] ä»»åŠ¡å·²è°ƒåº¦: æ€§èƒ½å†å²è®°å½•æ¸…ç† (0 1 * * *)
```

## ä½¿ç”¨è¯´æ˜

### æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€

åœ¨ç®¡ç†åå° â†’ è®¡åˆ’ä»»åŠ¡ç®¡ç† â†’ å†…éƒ¨ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°"æ€§èƒ½å†å²è®°å½•æ¸…ç†"ä»»åŠ¡ã€‚

### æ‰‹åŠ¨æ‰§è¡Œ

å¦‚æœéœ€è¦ç«‹å³æ¸…ç†å†å²æ•°æ®ï¼š

1. è¿›å…¥ç®¡ç†åå°çš„è®¡åˆ’ä»»åŠ¡ç®¡ç†
2. æ‰¾åˆ°"æ€§èƒ½å†å²è®°å½•æ¸…ç†"ä»»åŠ¡
3. ç‚¹å‡»"ç«‹å³æ‰§è¡Œ"æŒ‰é’®

### æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

åœ¨"æ‰§è¡Œæ—¥å¿—"æ ‡ç­¾é¡µä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
- æ‰§è¡Œæ—¶é—´
- æ‰§è¡ŒçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- åˆ é™¤çš„è®°å½•æ•°é‡
- æ‰§è¡Œè€—æ—¶

### è°ƒæ•´æ•°æ®ä¿ç•™æœŸ

å¦‚éœ€ä¿®æ”¹ 30 å¤©çš„ä¿ç•™æœŸï¼š

1. è¿›å…¥ç³»ç»Ÿé…ç½®ç®¡ç†
2. æ‰¾åˆ° `performance_data_retention_days` é…ç½®é¡¹
3. ä¿®æ”¹ä¸ºæ‰€éœ€å¤©æ•°ï¼ˆå¦‚ 7ã€15ã€60 ç­‰ï¼‰
4. é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ

## é¢„æœŸæ•ˆæœ

### é¦–æ¬¡æ‰§è¡Œ

- å¦‚æœå†å²æ•°æ®ç§¯ç´¯è¾ƒå¤šï¼Œé¦–æ¬¡æ‰§è¡Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
- å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸè§‚å¯Ÿé¦–æ¬¡æ‰§è¡Œæƒ…å†µ
- å¯èƒ½ä¼šåˆ é™¤æ•°åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡æ¡è®°å½•

### æ—¥å¸¸è¿è¡Œ

- æ¯å¤©å‡Œæ™¨ 1 ç‚¹è‡ªåŠ¨æ‰§è¡Œ
- é€šå¸¸åªåˆ é™¤å‰ä¸€å¤©è¶…è¿‡ 30 å¤©çš„æ•°æ®
- æ‰§è¡Œæ—¶é—´é€šå¸¸åœ¨å‡ ç§’åˆ°å‡ åç§’

### ç©ºé—´é‡Šæ”¾

- **è‡ªåŠ¨ VACUUM**: æ¸…ç†ä»»åŠ¡ä¼šè‡ªåŠ¨æ‰§è¡Œ `VACUUM ANALYZE` å›æ”¶æ­»å…ƒç»„ç©ºé—´
- **ç©ºé—´é‡ç”¨**: åˆ é™¤çš„ç©ºé—´ä¼šè¢«æ ‡è®°ä¸ºå¯é‡ç”¨ï¼Œæ–°æ•°æ®ä¼šä¼˜å…ˆä½¿ç”¨è¿™äº›ç©ºé—´
- **æŸ¥è¯¢æ€§èƒ½**: æ¸…ç†åæŸ¥è¯¢æ€§èƒ½ä¼šæ˜æ˜¾æå‡
- **å¤‡ä»½ä¼˜åŒ–**: å¤‡ä»½æ—¶é—´å’Œå¤‡ä»½æ–‡ä»¶å¤§å°ä¼šæ˜¾è‘—é™ä½

**æ³¨æ„**: PostgreSQL çš„ VACUUM åªå›æ”¶ç©ºé—´ä¾›é‡ç”¨ï¼Œä¸ä¼šç«‹å³å‡å°æ–‡ä»¶å¤§å°ã€‚å¦‚éœ€çœŸæ­£å‹ç¼©è¡¨æ–‡ä»¶ï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œï¼š
```sql
VACUUM FULL system_performance_history;
```
ä½† VACUUM FULL ä¼šé”è¡¨ï¼Œå»ºè®®åœ¨ç»´æŠ¤çª—å£æœŸæ‰§è¡Œã€‚

## ç›‘æ§å»ºè®®

### å…³æ³¨æŒ‡æ ‡

1. **åˆ é™¤è®°å½•æ•°**: æ¯å¤©åˆ é™¤çš„è®°å½•æ•°åº”è¯¥ç›¸å¯¹ç¨³å®š
2. **æ‰§è¡Œæ—¶é—´**: æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥åœ¨ 1 åˆ†é’Ÿå†…å®Œæˆ
3. **å¤±è´¥ç‡**: åº”è¯¥ä¿æŒåœ¨ 0%

### å¼‚å¸¸æƒ…å†µ

å¦‚æœå‡ºç°ä»¥ä¸‹æƒ…å†µï¼Œéœ€è¦æ£€æŸ¥ï¼š

- **åˆ é™¤è®°å½•æ•°çªç„¶å¢åŠ **: å¯èƒ½æ˜¯æ€§èƒ½ç›‘æ§é¢‘ç‡æé«˜äº†
- **æ‰§è¡Œæ—¶é—´è¿‡é•¿**: å¯èƒ½æ˜¯æ•°æ®åº“æ€§èƒ½é—®é¢˜æˆ–ç´¢å¼•ç¼ºå¤±
- **æ‰§è¡Œå¤±è´¥**: æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œæƒé™

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®ç»“æ„

```sql
-- system_performance_history è¡¨ç»“æ„
CREATE TABLE system_performance_history (
  id SERIAL PRIMARY KEY,
  metric_type VARCHAR(50) NOT NULL,  -- 'disk', 'cpu', 'memory'
  metric_value DECIMAL(5,2) NOT NULL,
  additional_data JSONB,
  recorded_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•ï¼ˆç”¨äºåŠ é€Ÿæ¸…ç†æŸ¥è¯¢ï¼‰
CREATE INDEX idx_performance_history_recorded_at 
ON system_performance_history(recorded_at);
```

### æ¸…ç†é€»è¾‘

```sql
DELETE FROM system_performance_history
WHERE recorded_at < NOW() - INTERVAL '30 days'
```

- ä½¿ç”¨æ—¶é—´æˆ³ç´¢å¼•ï¼Œåˆ é™¤æ•ˆç‡é«˜
- ä¸å½±å“æœ€è¿‘ 30 å¤©çš„æ•°æ®
- äº‹åŠ¡å®‰å…¨ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡æ‰§è¡Œ**: å¦‚æœå†å²æ•°æ®é‡å·¨å¤§ï¼ˆå¦‚æ•°ç™¾ä¸‡æ¡ï¼‰ï¼Œé¦–æ¬¡æ‰§è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®æ‰‹åŠ¨æ‰§è¡Œå¹¶è§‚å¯Ÿ
2. **æ•°æ®æ¢å¤**: åˆ é™¤çš„æ•°æ®æ— æ³•æ¢å¤ï¼Œç¡®ä¿ 30 å¤©çš„ä¿ç•™æœŸæ»¡è¶³ä¸šåŠ¡éœ€æ±‚
3. **ç›‘æ§å½±å“**: å¦‚æœæœ‰ç›‘æ§æŠ¥è¡¨ä¾èµ–å†å²æ•°æ®ï¼Œéœ€è¦ç¡®è®¤æ—¶é—´èŒƒå›´åœ¨ 30 å¤©å†…
4. **æ•°æ®åº“è´Ÿè½½**: æ¸…ç†æ“ä½œä¼šäº§ç”Ÿä¸€å®šçš„æ•°æ®åº“è´Ÿè½½ï¼Œé€‰æ‹©åœ¨å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œå¯ä»¥é¿å¼€ä¸šåŠ¡é«˜å³°

## æ•…éšœæ’æŸ¥

### ä»»åŠ¡æœªæ‰§è¡Œ

1. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯ç”¨: `SELECT * FROM scheduled_tasks WHERE script_path = 'performance-history-cleanup';`
2. æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
3. éªŒè¯ Cron è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®

### æ‰§è¡Œå¤±è´¥

1. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
3. éªŒè¯æ•°æ®åº“ç”¨æˆ·æ˜¯å¦æœ‰ DELETE æƒé™

### æ•°æ®æœªåˆ é™¤

1. æ£€æŸ¥ `performance_data_retention_days` é…ç½®å€¼
2. éªŒè¯ `system_performance_history` è¡¨ä¸­æ˜¯å¦æœ‰è¶…è¿‡ 30 å¤©çš„æ•°æ®
3. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ä¸­è¿”å›çš„åˆ é™¤è®°å½•æ•°

## ç›¸å…³æ–‡ä»¶

- `server/src/admin/services/register-internal-tasks.ts` - ä»»åŠ¡æ³¨å†Œ
- `server/src/services/performance-monitoring.service.ts` - æ¸…ç†é€»è¾‘å®ç°
- `server/migrations/incremental/add-performance-history-cleanup-task.sql` - æ•°æ®åº“è¿ç§»
- `docs/backend/20251212-æ€§èƒ½å†å²è®°å½•æ¸…ç†ä»»åŠ¡.md` - æœ¬æ–‡æ¡£
