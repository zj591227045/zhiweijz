# è¿ç§»å·¥å…·å’Œè„šæœ¬

## è‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬

### 1. ä¾èµ–åˆ†æè„šæœ¬

```bash
#!/bin/bash
# æ–‡ä»¶ï¼šscripts/analyze-dependencies.sh

echo "=== åˆ†æ useAccountBookStore ä½¿ç”¨æƒ…å†µ ==="

# æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨ useAccountBookStore çš„æ–‡ä»¶
echo "ğŸ“Š ä½¿ç”¨ç»Ÿè®¡ï¼š"
grep -r "useAccountBookStore" apps/ packages/ --include="*.ts" --include="*.tsx" | wc -l

echo -e "\nğŸ“ æŒ‰ç›®å½•åˆ†å¸ƒï¼š"
grep -r "useAccountBookStore" apps/ packages/ --include="*.ts" --include="*.tsx" | cut -d: -f1 | xargs dirname | sort | uniq -c | sort -nr

echo -e "\nğŸ“„ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨ï¼š"
grep -r "useAccountBookStore" apps/ packages/ --include="*.ts" --include="*.tsx" | cut -d: -f1 | sort | uniq

echo -e "\nğŸ” ä½¿ç”¨æ¨¡å¼åˆ†æï¼š"
echo "getState() è°ƒç”¨ï¼š"
grep -r "useAccountBookStore.getState()" apps/ packages/ --include="*.ts" --include="*.tsx" | wc -l

echo "hook è°ƒç”¨ï¼š"
grep -r "const.*useAccountBookStore" apps/ packages/ --include="*.ts" --include="*.tsx" | wc -l
```

### 2. è¿ç§»éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# æ–‡ä»¶ï¼šscripts/verify-migration.sh

COMPONENT_PATH=$1

if [ -z "$COMPONENT_PATH" ]; then
    echo "ç”¨æ³•: ./verify-migration.sh <ç»„ä»¶è·¯å¾„>"
    exit 1
fi

echo "=== éªŒè¯ç»„ä»¶è¿ç§»ï¼š$COMPONENT_PATH ==="

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ Zustand å¼•ç”¨
echo "ğŸ” æ£€æŸ¥ Zustand å¼•ç”¨ï¼š"
if grep -q "useAccountBookStore" "$COMPONENT_PATH"; then
    echo "âŒ ä»æœ‰ Zustand å¼•ç”¨"
    grep -n "useAccountBookStore" "$COMPONENT_PATH"
else
    echo "âœ… æ—  Zustand å¼•ç”¨"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ React Query å¼•ç”¨
echo -e "\nğŸ” æ£€æŸ¥ React Query å¼•ç”¨ï¼š"
if grep -q "useAccountBooks" "$COMPONENT_PATH"; then
    echo "âœ… å·²ä½¿ç”¨ React Query"
    grep -n "useAccountBooks" "$COMPONENT_PATH"
else
    echo "âŒ æœªä½¿ç”¨ React Query"
fi

# æ£€æŸ¥ç±»å‹å¯¼å…¥
echo -e "\nğŸ” æ£€æŸ¥ç±»å‹å¯¼å…¥ï¼š"
if grep -q "AccountBook" "$COMPONENT_PATH"; then
    echo "âœ… æœ‰ç±»å‹å¯¼å…¥"
else
    echo "âš ï¸  æ— ç±»å‹å¯¼å…¥"
fi
```

### 3. æ€§èƒ½ç›‘æ§è„šæœ¬

```typescript
// æ–‡ä»¶ï¼šscripts/performance-monitor.ts

interface RequestMetrics {
  url: string;
  count: number;
  timestamps: number[];
  duplicates: number;
}

class MigrationMonitor {
  private requests: Map<string, RequestMetrics> = new Map();
  private startTime = Date.now();

  constructor() {
    this.interceptFetch();
  }

  private interceptFetch() {
    const originalFetch = window.fetch;
    
    window.fetch = async (input, init) => {
      const url = typeof input === 'string' ? input : input.url;
      
      // åªç›‘æ§è´¦æœ¬ç›¸å…³è¯·æ±‚
      if (url.includes('/account-books')) {
        this.recordRequest(url);
      }
      
      return originalFetch(input, init);
    };
  }

  private recordRequest(url: string) {
    const now = Date.now();
    const existing = this.requests.get(url);
    
    if (existing) {
      existing.count++;
      existing.timestamps.push(now);
      
      // æ£€æµ‹é‡å¤è¯·æ±‚ï¼ˆ5ç§’å†…çš„ç›¸åŒè¯·æ±‚ï¼‰
      const recentRequests = existing.timestamps.filter(
        t => now - t < 5000
      );
      
      if (recentRequests.length > 1) {
        existing.duplicates++;
        console.warn(`ğŸ”„ æ£€æµ‹åˆ°é‡å¤è¯·æ±‚: ${url}`, {
          count: recentRequests.length,
          timestamps: recentRequests
        });
      }
    } else {
      this.requests.set(url, {
        url,
        count: 1,
        timestamps: [now],
        duplicates: 0
      });
    }
  }

  getReport(): string {
    const duration = Date.now() - this.startTime;
    const totalRequests = Array.from(this.requests.values())
      .reduce((sum, metric) => sum + metric.count, 0);
    const totalDuplicates = Array.from(this.requests.values())
      .reduce((sum, metric) => sum + metric.duplicates, 0);

    return `
=== è¿ç§»æ€§èƒ½æŠ¥å‘Š ===
ç›‘æ§æ—¶é•¿: ${Math.round(duration / 1000)}ç§’
æ€»è¯·æ±‚æ•°: ${totalRequests}
é‡å¤è¯·æ±‚: ${totalDuplicates}
å»é‡ç‡: ${totalDuplicates > 0 ? Math.round((totalDuplicates / totalRequests) * 100) : 0}%

è¯¦ç»†ç»Ÿè®¡:
${Array.from(this.requests.values())
  .map(metric => `${metric.url}: ${metric.count}æ¬¡è¯·æ±‚, ${metric.duplicates}æ¬¡é‡å¤`)
  .join('\n')}
    `;
  }
}

// ä½¿ç”¨æ–¹æ³•
if (typeof window !== 'undefined' && process.env.NODE_ENV === 'development') {
  (window as any).migrationMonitor = new MigrationMonitor();
  
  // 10ç§’åè¾“å‡ºæŠ¥å‘Š
  setTimeout(() => {
    console.log((window as any).migrationMonitor.getReport());
  }, 10000);
}
```

## è¿ç§»æ¨¡æ¿

### 1. ç»„ä»¶è¿ç§»æ¨¡æ¿

```typescript
// è¿ç§»å‰
import { useAccountBookStore } from '@/store/account-book-store';

export function MyComponent() {
  const { 
    currentAccountBook, 
    fetchAccountBooks, 
    isLoading, 
    error 
  } = useAccountBookStore();

  useEffect(() => {
    fetchAccountBooks();
  }, [fetchAccountBooks]);

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (error) return <div>é”™è¯¯: {error}</div>;

  return <div>{currentAccountBook?.name}</div>;
}
```

```typescript
// è¿ç§»å
import { useAccountBooks } from '@/hooks/useAccountBooks';

export function MyComponent() {
  const { 
    currentAccountBook, 
    isLoading, 
    error 
  } = useAccountBooks();

  // React Query è‡ªåŠ¨å¤„ç†æ•°æ®è·å–ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (error) return <div>é”™è¯¯: {error}</div>;

  return <div>{currentAccountBook?.name}</div>;
}
```

### 2. éReactä¸Šä¸‹æ–‡è¿ç§»æ¨¡æ¿

```typescript
// è¿ç§»å‰
import { useAccountBookStore } from '@/store/account-book-store';

function someUtilFunction() {
  const accountId = useAccountBookStore.getState().currentAccountBook?.id;
  return accountId;
}
```

```typescript
// è¿ç§»å
import { getCurrentAccountBookId } from '@/lib/account-book-global';

function someUtilFunction() {
  const accountId = getCurrentAccountBookId();
  return accountId;
}
```

## æµ‹è¯•å·¥å…·

### 1. è¿ç§»æµ‹è¯•å¥—ä»¶

```typescript
// æ–‡ä»¶ï¼š__tests__/migration.test.ts

import { renderHook } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useAccountBooks } from '@/hooks/useAccountBooks';

describe('è´¦æœ¬è¿ç§»æµ‹è¯•', () => {
  let queryClient: QueryClient;

  beforeEach(() => {
    queryClient = new QueryClient({
      defaultOptions: {
        queries: { retry: false },
        mutations: { retry: false },
      },
    });
  });

  const wrapper = ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );

  it('åº”è¯¥æä¾›ä¸Zustandç›¸åŒçš„æ¥å£', () => {
    const { result } = renderHook(() => useAccountBooks(), { wrapper });

    // éªŒè¯æ¥å£å…¼å®¹æ€§
    expect(result.current).toHaveProperty('accountBooks');
    expect(result.current).toHaveProperty('currentAccountBook');
    expect(result.current).toHaveProperty('isLoading');
    expect(result.current).toHaveProperty('error');
    expect(result.current).toHaveProperty('fetchAccountBooks');
    expect(result.current).toHaveProperty('setCurrentAccountBook');
  });

  it('åº”è¯¥è‡ªåŠ¨ç¼“å­˜è¯·æ±‚', async () => {
    // æ¨¡æ‹ŸAPIè°ƒç”¨
    const mockFetch = jest.fn().mockResolvedValue([]);
    
    // ç¬¬ä¸€æ¬¡è°ƒç”¨
    const { result: result1 } = renderHook(() => useAccountBooks(), { wrapper });
    
    // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆåº”è¯¥ä½¿ç”¨ç¼“å­˜ï¼‰
    const { result: result2 } = renderHook(() => useAccountBooks(), { wrapper });

    // éªŒè¯åªè°ƒç”¨äº†ä¸€æ¬¡API
    expect(mockFetch).toHaveBeenCalledTimes(1);
  });
});
```

### 2. E2Eæµ‹è¯•

```typescript
// æ–‡ä»¶ï¼še2e/migration.spec.ts

import { test, expect } from '@playwright/test';

test.describe('è´¦æœ¬è¿ç§»E2Eæµ‹è¯•', () => {
  test('ä»ªè¡¨ç›˜é¡µé¢åº”è¯¥æ­£å¸¸åŠ è½½è´¦æœ¬æ•°æ®', async ({ page }) => {
    await page.goto('/dashboard');
    
    // ç­‰å¾…è´¦æœ¬æ•°æ®åŠ è½½
    await expect(page.locator('[data-testid="account-book-name"]')).toBeVisible();
    
    // éªŒè¯æ²¡æœ‰é‡å¤è¯·æ±‚
    const requests = [];
    page.on('request', request => {
      if (request.url().includes('/account-books')) {
        requests.push(request);
      }
    });
    
    // åˆ·æ–°é¡µé¢
    await page.reload();
    
    // éªŒè¯è¯·æ±‚å»é‡
    expect(requests.length).toBeLessThanOrEqual(1);
  });

  test('è´¦æœ¬åˆ‡æ¢åº”è¯¥æ­£å¸¸å·¥ä½œ', async ({ page }) => {
    await page.goto('/dashboard');
    
    // ç‚¹å‡»è´¦æœ¬åˆ‡æ¢
    await page.click('[data-testid="account-book-selector"]');
    await page.click('[data-testid="account-book-option-1"]');
    
    // éªŒè¯è´¦æœ¬å·²åˆ‡æ¢
    await expect(page.locator('[data-testid="current-account-book"]')).toContainText('æ–°è´¦æœ¬');
  });
});
```

## ä½¿ç”¨è¯´æ˜

### 1. å¼€å§‹è¿ç§»å‰
```bash
# è¿è¡Œä¾èµ–åˆ†æ
./scripts/analyze-dependencies.sh

# å¯åŠ¨æ€§èƒ½ç›‘æ§
# åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œç›‘æ§è„šæœ¬
```

### 2. è¿ç§»å•ä¸ªç»„ä»¶
```bash
# 1. å¤‡ä»½åŸæ–‡ä»¶
cp src/components/MyComponent.tsx src/components/MyComponent.tsx.backup

# 2. æŒ‰æ¨¡æ¿ä¿®æ”¹ç»„ä»¶

# 3. éªŒè¯è¿ç§»
./scripts/verify-migration.sh src/components/MyComponent.tsx

# 4. è¿è¡Œæµ‹è¯•
npm test -- MyComponent
```

### 3. ç›‘æ§è¿ç§»æ•ˆæœ
```bash
# è¿è¡ŒE2Eæµ‹è¯•
npm run test:e2e

# æ£€æŸ¥æ€§èƒ½æŠ¥å‘Š
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ migrationMonitor.getReport()
```

è¿™äº›å·¥å…·å’Œè„šæœ¬å°†å¸®åŠ©ä½ å®‰å…¨ã€é«˜æ•ˆåœ°å®Œæˆè¿ç§»è¿‡ç¨‹ã€‚