# 快速开始指南

## 立即开始迁移

### 第一步：选择迁移目标

**推荐从这些组件开始**（影响小，收益大）：

1. `app/dashboard/page.tsx` - 仪表盘主页
2. `components/share/share-image-handler.tsx` - 分享组件  
3. `app/settings/page.tsx` - 设置页面

### 第二步：迁移单个组件

以 `app/dashboard/page.tsx` 为例：

#### 当前代码
```typescript
import { useAccountBookStore } from '@/store/account-book-store';

export default function DashboardPage() {
  const { currentAccountBook, fetchAccountBooks } = useAccountBookStore();
  
  useEffect(() => {
    fetchAccountBooks();
  }, [fetchAccountBooks]);
  
  return <div>{currentAccountBook?.name}</div>;
}
```

#### 迁移后代码
```typescript
import { useAccountBooks } from '@/hooks/useAccountBooks';

export default function DashboardPage() {
  const { currentAccountBook } = useAccountBooks();
  
  // React Query 自动处理数据获取，删除 useEffect
  
  return <div>{currentAccountBook?.name}</div>;
}
```

#### 变更说明
- ✅ 导入路径：`@/store/account-book-store` → `@/hooks/useAccountBooks`
- ✅ 删除手动调用：不需要 `fetchAccountBooks()` 和 `useEffect`
- ✅ 接口保持一致：`currentAccountBook` 等属性名不变

### 第三步：验证迁移效果

#### 功能验证
1. 页面正常加载 ✅
2. 账本数据正确显示 ✅  
3. 无控制台错误 ✅

#### 性能验证
打开浏览器开发者工具 → Network 面板：

**迁移前**：
```
GET /api/account-books (200ms)
GET /api/account-books (200ms) // 重复请求
GET /api/account-books (200ms) // 重复请求
```

**迁移后**：
```
GET /api/account-books (200ms) // 只有一次请求
```

## 常见迁移场景

### 场景1：基础数据获取
```typescript
// 旧代码
const { currentAccountBook, isLoading, error } = useAccountBookStore();

// 新代码（无变化）
const { currentAccountBook, isLoading, error } = useAccountBooks();
```

### 场景2：手动刷新数据
```typescript
// 旧代码
const { fetchAccountBooks } = useAccountBookStore();
const handleRefresh = () => fetchAccountBooks();

// 新代码（无变化）
const { fetchAccountBooks } = useAccountBooks();
const handleRefresh = () => fetchAccountBooks();
```

### 场景3：账本切换
```typescript
// 旧代码
const { setCurrentAccountBook } = useAccountBookStore();
const handleSwitch = (book) => setCurrentAccountBook(book);

// 新代码（无变化）
const { setCurrentAccountBook } = useAccountBooks();
const handleSwitch = (book) => setCurrentAccountBook(book);
```

### 场景4：非React上下文使用
```typescript
// 旧代码
import { useAccountBookStore } from '@/store/account-book-store';
const accountId = useAccountBookStore.getState().currentAccountBook?.id;

// 新代码
import { getCurrentAccountBookId } from '@/lib/account-book-global';
const accountId = getCurrentAccountBookId();
```

## 迁移检查清单

每完成一个组件迁移，检查以下项目：

### 代码检查
- [ ] 导入路径已更新
- [ ] 删除了不必要的 `useEffect`
- [ ] 处理了 `.getState()` 调用
- [ ] 类型导入正确

### 功能检查  
- [ ] 页面正常加载
- [ ] 数据正确显示
- [ ] 交互功能正常
- [ ] 错误处理正常

### 性能检查
- [ ] 网络请求减少
- [ ] 页面加载更快
- [ ] 无重复请求
- [ ] 缓存生效

## 遇到问题？

### 常见问题

**Q: 迁移后数据不显示**
```typescript
// 检查是否正确导入
import { useAccountBooks } from '@/hooks/useAccountBooks'; // ✅
import { useAccountBooks } from '@/store/account-book-store'; // ❌
```

**Q: TypeScript 类型错误**
```typescript
// 确保导入类型
import { AccountBook } from '@/types';
```

**Q: 非React上下文报错**
```typescript
// 使用全局访问器
import { getCurrentAccountBookId } from '@/lib/account-book-global';
```

### 回滚方案
如果迁移出现问题，可以快速回滚：

```typescript
// 临时回滚到 Zustand
import { useAccountBookStore } from '@/store/account-book-store';
// 恢复原有代码
```

### 获得帮助
- 查看完整文档：`docs/20251213-基于React-Query的请求去重改造/README.md`
- 使用迁移工具：`docs/20251213-基于React-Query的请求去重改造/迁移工具.md`
- 参考测试用例：`__tests__/migration.test.ts`

## 下一步

完成第一个组件迁移后：

1. **验证效果**：确认请求去重和缓存生效
2. **继续迁移**：选择下一个优先级组件
3. **监控性能**：使用性能监控工具跟踪改进
4. **分享经验**：记录遇到的问题和解决方案

**记住**：每次只迁移一个组件，确保系统稳定后再继续下一个。这样可以最大程度降低风险，确保"Never break userspace"。