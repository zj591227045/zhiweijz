# 用户自主注销账户功能测试指南

## 功能概述

用户自主注销账户功能允许用户通过三次确认机制和24小时冷静期来安全地删除自己的账户。

## 功能特性

### 前端功能
1. **注销入口**：在设置页面的"关于"部分添加了"注销账户"按钮（红色样式）
2. **三次确认机制**：
   - 第一次：阅读注销后果说明并确认
   - 第二次：输入当前登录密码验证身份
   - 第三次：输入"确认注销"文字进行最终确认
3. **24小时冷静期**：确认后进入冷静期，显示倒计时
4. **取消注销**：在冷静期内可以取消注销请求
5. **状态横幅**：在冷静期内显示注销状态提醒
6. **美观界面**：
   - 模糊背景效果（backdrop-filter: blur(8px)）
   - 居中显示的模态框
   - 符合主题变量的渐变背景
   - 流畅的动画效果
   - 响应式设计支持移动端

### 后端功能
1. **API端点**：
   - `POST /api/users/me/request-deletion` - 发起注销请求
   - `POST /api/users/me/cancel-deletion` - 取消注销请求
   - `GET /api/users/me/deletion-status` - 查询注销状态
   - `POST /api/users/me/verify-password` - 验证密码
2. **数据库字段**：
   - `deletion_requested_at` - 注销请求时间
   - `deletion_scheduled_at` - 预定注销时间（24小时后）
3. **定时任务**：自动处理过期的注销请求
4. **数据清理**：完整删除用户相关的所有数据

## 测试步骤

### 1. 基础功能测试

#### 1.1 注销入口测试
1. 登录系统
2. 进入设置页面
3. 点击"关于应用"
4. 确认页面底部显示"注销账户"按钮（红色样式）

#### 1.2 三次确认流程测试
1. 点击"注销账户"按钮
2. **第一步**：确认显示警告说明弹窗
   - 检查是否显示注销后果说明
   - 点击"我已了解，继续"进入下一步
3. **第二步**：密码验证
   - 输入错误密码，点击"下一步"，确认显示"密码错误"提示
   - 输入正确密码，点击"下一步"，确认显示"验证中..."状态
   - 密码验证成功后自动进入下一步
4. **第三步**：最终确认
   - 输入错误文字，确认显示错误提示
   - 输入"确认注销"，点击"确认注销账户"

#### 1.3 冷静期测试
1. 完成注销请求后，确认显示冷静期界面
2. 检查倒计时显示是否正确（应显示约24小时）
3. 确认显示注销请求时间和预定删除时间

### 2. 取消注销测试

#### 2.1 在弹窗中取消
1. 在冷静期界面点击"取消注销"按钮
2. 确认注销请求被取消
3. 确认弹窗关闭，回到正常状态

#### 2.2 通过状态横幅取消
1. 发起注销请求
2. 关闭弹窗，确认页面顶部显示注销状态横幅
3. 点击横幅中的"取消注销"按钮
4. 确认注销请求被取消，横幅消失

### 3. 登录限制测试

#### 3.1 冷静期登录测试
1. 发起注销请求
2. 退出登录
3. 尝试重新登录
4. 确认登录时显示"账户正在注销中"提示
5. 确认只能访问注销状态查询和取消注销功能

### 4. 权限检查测试

#### 4.1 账本管理员检查
1. 创建一个账本并确保当前用户是唯一管理员
2. 尝试发起注销请求
3. 确认显示"需要先转移管理权或删除账本"的错误提示

### 5. API测试

#### 5.1 注销状态查询
```bash
# 获取注销状态
curl -X GET http://localhost:3000/api/users/me/deletion-status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5.2 发起注销请求
```bash
# 发起注销请求
curl -X POST http://localhost:3000/api/users/me/request-deletion \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "password": "your_password",
    "confirmText": "确认注销"
  }'
```

#### 5.3 取消注销请求
```bash
# 取消注销请求
curl -X POST http://localhost:3000/api/users/me/cancel-deletion \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5.4 验证密码
```bash
# 验证密码
curl -X POST http://localhost:3000/api/users/me/verify-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "password": "your_password"
  }'
```

### 6. 数据库验证

#### 6.1 检查注销字段
```sql
-- 查看用户注销状态
SELECT id, email, deletion_requested_at, deletion_scheduled_at 
FROM users 
WHERE deletion_requested_at IS NOT NULL;
```

#### 6.2 检查定时任务
1. 手动修改数据库中的 `deletion_scheduled_at` 为过去时间
2. 等待定时任务执行（每小时检查一次）
3. 确认用户数据被完全删除

## 安全注意事项

1. **密码验证**：确保注销请求需要正确的密码验证
2. **数据完整性**：确认删除操作包含所有相关数据
3. **不可恢复性**：确认删除后数据无法恢复
4. **日志记录**：确认重要操作有相应的日志记录

## 已知限制

1. 定时任务每小时执行一次，实际删除时间可能有1小时误差
2. 如果用户是账本唯一管理员，需要先处理账本归属
3. 微信绑定等第三方关联数据也会被清理

## 演示页面

可以通过以下演示页面体验注销功能的界面效果：
- 文件位置：`docs/features/account-deletion-demo.html`
- 包含完整的视觉效果演示
- 展示模糊背景和动画效果

## 故障排除

### 常见问题
1. **注销按钮不显示**：检查前端编译和样式文件
2. **API调用失败**：检查后端服务和数据库连接
3. **定时任务不执行**：检查服务器启动日志
4. **数据未删除**：检查数据库事务和外键约束
5. **模态框样式异常**：检查CSS变量和主题设置
6. **模糊效果不生效**：检查浏览器对backdrop-filter的支持
7. **取消注销无效**：检查API客户端的401错误处理
8. **自动跳转登录页**：检查响应拦截器的错误处理逻辑
9. **重复注销请求失败**：现已修复，重复请求返回现有注销时间

### 调试方法
1. 查看浏览器控制台错误
2. 查看后端服务日志
3. 检查数据库表结构和数据
4. 验证API响应格式
5. 使用浏览器开发者工具检查CSS样式
6. 测试不同浏览器的兼容性

### 重置注销状态
如果需要重置测试用户的注销状态，可以运行：
```bash
cd server
node scripts/reset-deletion-status.js
```

### 测试取消注销功能
如果需要测试取消注销功能，可以运行：
```bash
cd server
node scripts/test-cancel-deletion.js
```

### API错误码说明
- **423 Locked**：用户处于注销冷静期，大部分操作被限制
- **400 Bad Request**：请求参数错误（如密码错误、确认文字错误）
- **401 Unauthorized**：未授权访问
- **500 Internal Server Error**：服务器内部错误
