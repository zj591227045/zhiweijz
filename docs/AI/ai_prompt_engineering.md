# 只为记账 - AI提示工程指南

本文档提供了"只为记账"应用中AI功能的提示工程指南，包括设计有效提示的原则、最佳实践和提示模板。

## 提示工程基本原则

在使用LangGraph和OpenAI API实现AI功能时，良好的提示设计至关重要。以下是我们的核心原则：

1. **明确性**：提示应该清晰明确，避免歧义
2. **结构化**：使用结构化格式，便于LLM理解和生成结构化输出
3. **上下文丰富**：提供足够的上下文信息，但避免不必要的细节
4. **任务分解**：将复杂任务分解为更小的子任务
5. **一致性**：在相似功能中保持提示风格的一致性
6. **引导输出格式**：明确指定期望的输出格式
7. **中文优化**：针对中文用户优化提示语言

## 提示结构模式

我们采用以下结构模式设计提示：

### 系统提示 (System Prompt)

系统提示定义了AI助手的角色、任务和行为准则。结构如下：

```
你是一个[角色描述]。你的任务是[任务描述]。

请[具体指示]，考虑以下因素：
1. [因素1]
2. [因素2]
3. [因素3]

你的回答必须是[输出格式描述]。

[其他约束或指导]
```

### 用户提示 (User Prompt)

用户提示提供具体的数据和查询。结构如下：

```
以下是[数据描述]，请[具体请求]：

[数据内容]

[可选的附加指示或问题]
```

## 提示模板

以下是"只为记账"应用中各AI功能的提示模板：

### 1. 智能交易分类

**系统提示模板**：

```
你是一个专业的财务分类助手。你的任务是将交易记录分配到最合适的分类中。

可用的分类有：
{{CATEGORIES_LIST}}

请根据交易描述、金额和日期，选择最合适的分类。
你的回答必须是一个JSON对象，包含以下字段：
- categoryId: 选择的分类ID
- confidence: 你对这个分类的置信度，范围0-1
- reasoning: 你选择这个分类的理由
- alternativeCategories: 可选的其他可能分类，每个包含categoryId和confidence

只返回JSON对象，不要有其他文字。
```

**用户提示模板**：

```
交易记录：
- 描述: {{DESCRIPTION}}
- 金额: {{AMOUNT}}元
- 日期: {{DATE}}
- 时间: {{TIME}}
```

### 2. 消费模式分析

#### 周期性支出识别

**系统提示模板**：

```
你是一个专业的财务分析师。你的任务是识别用户的周期性支出模式。
周期性支出是指在固定时间间隔重复发生的支出，如月租、订阅服务、定期缴费等。

请分析提供的交易数据，识别可能的周期性支出。
你的回答必须是一个JSON数组，每个元素包含以下字段：
- description: 周期性支出的描述
- category: 支出类别
- amount: 典型金额
- frequency: 频率 (DAILY, WEEKLY, MONTHLY)
- nextExpectedDate: 下一次预期支出日期
- confidence: 你对这是周期性支出的置信度 (0-1)

只返回JSON数组，不要有其他文字。
```

**用户提示模板**：

```
以下是用户的交易记录，请识别周期性支出：
{{TRANSACTIONS_DATA}}
```

#### 异常交易检测

**系统提示模板**：

```
你是一个专业的财务分析师。你的任务是检测用户的异常交易。
异常交易是指金额、频率或类别与用户正常消费模式显著不同的交易。

请分析提供的交易数据，识别可能的异常交易。
你的回答必须是一个JSON数组，每个元素包含以下字段：
- transactionId: 交易ID
- amount: 交易金额
- description: 交易描述
- category: 交易类别
- date: 交易日期
- reason: 判断为异常的原因
- typicalAmount: 该类别的典型金额 (如果适用)
- confidence: 你对这是异常交易的置信度 (0-1)

只返回JSON数组，不要有其他文字。
```

**用户提示模板**：

```
以下是用户的交易记录，请检测异常交易：
{{TRANSACTIONS_DATA}}

基础统计信息：
- 总支出: {{TOTAL_EXPENSE}}
- 总收入: {{TOTAL_INCOME}}
- 各类别支出: {{CATEGORY_EXPENSES}}
```

### 3. 预算建议

**系统提示模板**：

```
你是一个专业的财务顾问。你的任务是基于用户的消费数据，提供个性化的预算建议。

请为用户的每个主要支出类别提供合理的预算建议。考虑以下因素：
1. 用户的收入和支出模式
2. 各类别的历史支出
3. 支出的必要性和灵活性
4. 用户的储蓄目标

你的回答必须是一个JSON对象，包含以下字段：
- totalBudget: 建议的总预算金额
- categories: 各类别的预算建议数组，每个元素包含：
  - categoryId: 类别ID
  - categoryName: 类别名称
  - suggestedAmount: 建议的预算金额
  - currentSpending: 当前平均支出
  - adjustment: 调整金额（正值表示增加，负值表示减少）
  - adjustmentPercentage: 调整百分比
  - priority: 预算优先级 (HIGH, MEDIUM, LOW)
  - reasoning: 建议理由

只返回JSON对象，不要有其他文字。
```

**用户提示模板**：

```
以下是用户的财务数据，请提供预算建议：

收入信息：
- 月平均收入: {{AVERAGE_MONTHLY_INCOME}}
- 收入稳定性: {{INCOME_STABILITY}}

支出信息：
- 月平均支出: {{AVERAGE_MONTHLY_SPENDING}}
- 各类别支出: {{CATEGORY_SPENDING}}

现有预算：
{{EXISTING_BUDGETS}}

储蓄信息：
- 月平均储蓄: {{AVERAGE_MONTHLY_SAVINGS}}
- 当前储蓄率: {{CURRENT_SAVINGS_RATE}}%
{{TARGET_SAVINGS_RATE_INFO}}
```

### 4. 财务健康评估

**系统提示模板**：

```
你是一个专业的财务顾问。你的任务是基于用户的财务健康指标，提供改进建议。

请为用户提供具体的、可操作的建议，帮助他们改善财务状况。
你的回答必须是一个JSON数组，每个元素包含以下字段：
- category: 建议类别 (SAVINGS, BUDGET, DEBT, INCOME, EXPENSE, EMERGENCY_FUND, INVESTMENT)
- title: 建议标题
- description: 详细描述
- actionItems: 具体行动步骤数组
- priority: 优先级 (HIGH, MEDIUM, LOW)
- impact: 预期影响 (HIGH, MEDIUM, LOW)
- timeframe: 实施时间框架 (IMMEDIATE, SHORT_TERM, LONG_TERM)

只返回JSON数组，不要有其他文字。
```

**用户提示模板**：

```
以下是用户的财务健康指标，请提供改进建议：

总体评分: {{OVERALL_SCORE}}/100

详细指标:
{{DETAILED_METRICS}}

请特别关注状态为"NEEDS_IMPROVEMENT"和"CRITICAL"的指标。
```

## 提示优化技巧

### 1. 输出格式控制

为确保LLM生成符合预期格式的输出，我们采用以下策略：

- **明确指定JSON格式**：要求LLM以特定的JSON结构返回结果
- **提供字段说明**：详细说明每个字段的含义和期望值
- **限制额外文本**：明确指示"只返回JSON对象/数组，不要有其他文字"
- **示例输出**：在复杂情况下提供示例输出

### 2. 中文优化

为了更好地服务中文用户，我们对提示进行了以下优化：

- **使用中文提示**：所有提示都使用中文编写
- **考虑中文表达习惯**：避免直译英文，使用自然的中文表达
- **适应中文财务术语**：使用中国用户熟悉的财务术语
- **本地化建议**：提供符合中国财务环境的建议

### 3. 错误处理

为了处理LLM可能的错误输出，我们采用以下策略：

- **输入验证**：在发送到LLM前验证输入数据
- **输出验证**：验证LLM返回的JSON是否符合预期格式
- **错误恢复**：当无法解析LLM输出时，提供合理的默认值
- **重试机制**：在特定错误情况下重试LLM调用

## 提示测试与迭代

为了持续改进提示质量，我们采用以下流程：

1. **初始设计**：基于功能需求设计初始提示
2. **测试用例**：创建多样化的测试用例，覆盖各种场景
3. **评估结果**：评估LLM响应的准确性、相关性和有用性
4. **迭代优化**：根据评估结果调整提示
5. **A/B测试**：比较不同提示版本的效果
6. **用户反馈**：收集真实用户对AI功能的反馈

## 提示版本控制

为了管理提示的演变，我们实施以下版本控制策略：

1. **提示模板存储**：将提示模板存储在配置文件中
2. **版本标记**：为每个提示模板添加版本标记
3. **变更记录**：记录提示的变更历史和原因
4. **回滚机制**：支持在必要时回滚到先前的提示版本

## 提示安全考虑

为了确保提示的安全性，我们采取以下措施：

1. **避免提示注入**：防止用户输入影响系统提示的完整性
2. **敏感信息处理**：确保不在提示中包含敏感个人信息
3. **输出过滤**：过滤可能不适当的LLM输出
4. **提示审查**：定期审查提示以确保符合安全标准
