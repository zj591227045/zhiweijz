# 火山方舟平台集成指南

本文档介绍如何在"只为记账"项目中集成火山方舟平台的LLM和视觉识别服务。

## 概述

火山方舟是字节跳动推出的大模型服务平台，提供豆包系列模型的API服务。本项目已集成火山方舟作为LLM和视觉识别的提供商之一。

## 功能特性

### 1. LLM文字生成
- 支持豆包系列模型
- 兼容OpenAI API格式
- 支持多提供商负载均衡
- 自动故障转移
- 健康检查机制

### 2. 视觉识别
- 支持图片内容识别
- 支持智能记账场景
- 多模态对话能力
- 支持多种图片格式

## 配置步骤

### 1. 获取API密钥

1. 访问 [火山方舟控制台](https://console.volcengine.com/ark)
2. 创建应用并获取API密钥
3. 创建推理接入点，获取接入点ID（如：ep-20241217-xxxxx）

### 2. LLM配置

#### 方式一：多提供商配置（推荐）

1. 登录管理后台
2. 进入"多提供商LLM管理"页面
3. 点击"添加提供商"
4. 选择"火山方舟"
5. 填写配置信息：
   - **名称**: 自定义名称（如：火山方舟-豆包Pro）
   - **API密钥**: 从控制台获取的API密钥
   - **模型**: 接入点ID（如：ep-20241217-xxxxx）
   - **基础URL**: https://ark.cn-beijing.volces.com/api/v3
   - **温度**: 0.7（推荐）
   - **最大Token数**: 1000
   - **优先级**: 设置优先级（数字越小优先级越高）
   - **权重**: 负载均衡权重

#### 方式二：全局LLM配置

1. 进入"LLM设置"页面
2. 选择提供商：volcengine
3. 填写相应配置

### 3. 视觉识别配置

1. 进入"多模态AI配置"页面
2. 在"视觉识别"标签页中：
   - **启用**: 开启视觉识别功能
   - **服务提供商**: 选择"火山方舟"
   - **模型**: 填写视觉模型的接入点ID
   - **API密钥**: 填写API密钥
   - **基础URL**: https://ark.cn-beijing.volces.com/api/v3
   - **详细级别**: auto（推荐）
   - **超时时间**: 30秒

## 模型说明

### LLM模型
火山方舟使用接入点ID作为模型名称，常见格式：
- `ep-20241217-xxxxx` - 豆包-pro-4k
- `ep-20241217-yyyyy` - 豆包-pro-32k
- `ep-20241217-zzzzz` - 豆包-lite-4k

### 视觉模型
视觉识别同样使用接入点ID：
- `ep-20241217-vision-1` - 豆包视觉模型
- `ep-20241217-vision-2` - 豆包多模态模型

**注意**: 实际的接入点ID需要在火山方舟控制台中创建获取。

## 健康检查

火山方舟提供商使用特殊的健康检查机制：
- LLM: 使用 `/chat/completions` 端点进行简单对话测试
- 视觉: 使用 `/chat/completions` 端点进行图片识别测试

## API限制

### 请求限制
- 单次请求最大Token数: 根据模型而定
- 图片大小限制: 10MB
- 支持的图片格式: JPG, PNG, GIF, BMP, WebP

### 频率限制
- 根据火山方舟控制台配置的QPS限制
- 建议配置合理的重试机制

## 错误处理

常见错误及解决方案：

### 1. API密钥错误
```
错误: 401 Unauthorized
解决: 检查API密钥是否正确，是否有权限访问指定模型
```

### 2. 模型不存在
```
错误: 404 Model not found
解决: 检查接入点ID是否正确，是否已在控制台创建
```

### 3. 请求频率限制
```
错误: 429 Too Many Requests
解决: 降低请求频率，或升级服务套餐
```

### 4. 图片格式不支持
```
错误: 400 Unsupported image format
解决: 使用支持的图片格式（JPG, PNG等）
```

## 最佳实践

### 1. 多提供商配置
- 配置多个提供商实现故障转移
- 设置合理的优先级和权重
- 启用健康检查

### 2. 模型选择
- 根据场景选择合适的模型
- 考虑成本和性能平衡
- 测试不同模型的效果

### 3. 参数调优
- 温度参数: 0.1-0.9，创意任务用高值，精确任务用低值
- 最大Token数: 根据实际需求设置
- 超时时间: 考虑网络延迟，建议30-60秒

### 4. 监控和日志
- 监控API调用成功率
- 记录错误日志便于排查
- 定期检查健康状态

## 技术实现

### 提供商实现
- `VolcengineProvider`: LLM提供商实现
- `VolcengineVisionProvider`: 视觉识别提供商实现
- 支持OpenAI兼容API格式
- 自动错误处理和重试

### 配置管理
- 支持动态配置更新
- 配置验证和测试
- 安全的密钥存储

## 故障排除

### 1. 连接测试失败
1. 检查网络连接
2. 验证API密钥和接入点ID
3. 确认服务状态

### 2. 识别效果不佳
1. 调整提示词
2. 尝试不同模型
3. 优化图片质量

### 3. 性能问题
1. 检查网络延迟
2. 优化请求参数
3. 考虑使用CDN

## 相关链接

- [火山方舟官方文档](https://www.volcengine.com/docs/82379)
- [API参考文档](https://www.volcengine.com/docs/82379/1494384)
- [控制台地址](https://console.volcengine.com/ark)
