# 时区问题修复方案

## 问题根源

1. **数据库时区配置正确**：`Asia/Shanghai`
2. **Prisma客户端时区配置缺失**：连接字符串中没有指定时区参数
3. **结果**：Prisma使用UTC时区生成 `created_at` 和 `updated_at`，导致时间偏差8小时

## 修复方案

### 1. 测试环境（10.255.0.43）

**已修复**：在 `server/.env` 中添加时区参数

```bash
DATABASE_URL='postgresql://zhiweijz:zhiweijz123@10.255.0.43:5432/zhiweijz?schema=public&timezone=Asia/Shanghai'
```

### 2. 正式环境（100.64.0.10）

**需要修改服务器配置文件**：

```bash
# SSH登录到正式环境服务器
# 修改 .env 文件中的 DATABASE_URL

# 原配置（推测）：
DATABASE_URL='postgresql://zhiweijz:zhiweijz123@100.64.0.10:5432/zhiweijz?schema=public'

# 修改为：
DATABASE_URL='postgresql://zhiweijz:zhiweijz123@100.64.0.10:5432/zhiweijz?schema=public&timezone=Asia/Shanghai'

# 重启服务
pm2 restart all
# 或
docker-compose restart
```

### 3. Docker环境时区配置

**新增时区环境变量**（支持自定义时区）：

```bash
# docker/.env
DB_TIMEZONE=Asia/Shanghai  # 默认北京时间

# 其他常用时区：
# DB_TIMEZONE=UTC                    # 协调世界时
# DB_TIMEZONE=America/New_York       # 美国东部时间
# DB_TIMEZONE=Europe/London          # 英国时间
# DB_TIMEZONE=Asia/Tokyo             # 日本时间
```

**docker-compose.yml 自动使用时区变量**：

```yaml
DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?schema=public&timezone=${DB_TIMEZONE}
```

### 3. 代码修改

**智能记账日期处理**（`server/src/ai/langgraph/smart-accounting.ts`）：

✅ 已修改，处理LLM返回纯日期字符串的边界情况。

**微信记账的时区处理简化**（`server/src/services/wechat-smart-accounting.service.ts`）：

✅ 已简化，移除了不必要的时区转换代码。

原代码的问题：
```typescript
// 旧代码（复杂且无效）：
const now = new Date();
const beijingOffset = 8 * 60;
const utc = now.getTime() + now.getTimezoneOffset() * 60000;
const beijingTime = new Date(utc + beijingOffset * 60000);
// 实际上beijingTime === now（正负抵消）
```

简化后：
```typescript
// 新代码（简洁明了）：
const now = new Date(); // Prisma时区配置正确后，直接使用即可
```

**为什么修复后微信记账仍然正确？**

微信记账的时区转换代码虽然复杂，但实际上什么都没做（正负抵消）。修复Prisma时区配置后：
- date字段：由代码生成，使用本地时间，正确 ✅
- created_at字段：由Prisma生成，现在使用Asia/Shanghai时区，正确 ✅

**结论**：修复后所有记账方式（包括微信）的时间都正确。

## 验证步骤

### 1. 修改配置后重启服务

### 2. 创建测试记账记录

```bash
# 通过API创建记账记录
# 检查数据库中的时间是否正确
```

### 3. 查询数据库验证

```sql
-- 查看最新记账记录的时间
SELECT id, description, date, created_at, updated_at 
FROM transactions 
ORDER BY created_at DESC 
LIMIT 5;

-- 验证时间是否正确（应该与当前北京时间一致）
SELECT NOW();
```

## 预期结果

修复后，所有记账方式（文字、语音、图片、手动）的时间都应该正确，与当前北京时间一致。

## 注意事项

1. **历史数据**：已有的错误时间记录不会自动修正
2. **向后兼容**：新配置不影响现有功能
3. **微信记账**：由于有特殊的时区处理，修复前后都能正常工作

## 技术细节

### Prisma时区处理机制

- Prisma客户端默认使用UTC时区
- 通过连接字符串的 `timezone` 参数可以指定时区
- `@default(now())` 使用数据库的 `now()` 函数，受数据库时区影响
- `@updatedAt` 由Prisma客户端生成，受连接字符串时区参数影响

### PostgreSQL时区设置

```sql
-- 查看数据库时区
SHOW timezone;

-- 设置数据库时区
ALTER DATABASE zhiweijz SET timezone TO 'Asia/Shanghai';

-- 查看当前时间
SELECT NOW();
```

## 总结

**根本原因**：Prisma连接字符串缺少时区参数

**修复方案**：在连接字符串中添加 `&timezone=Asia/Shanghai`

**影响范围**：所有通过Prisma创建的记录的 `created_at` 和 `updated_at` 字段

**修复难度**：⭐（非常简单，只需修改一行配置）
