# App内购买测试指南

本指南将帮助您在沙盒环境中测试App内购买和订阅功能。

## 1. 测试环境准备

### 1.1 沙盒测试账户

1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 进入 "用户和访问" → "沙盒测试员"
3. 创建测试账户：
   - 邮箱: test@example.com
   - 密码: TestPassword123
   - 姓名: Test User
   - 地区: 中国

### 1.2 设备配置

**iOS设备设置：**
1. 设置 → App Store → 退出当前Apple ID
2. 不要在设置中登录沙盒账户
3. 只在应用内购买时登录沙盒账户

**开发环境设置：**
```bash
# 确保使用开发环境配置
NODE_ENV=development
NEXT_PUBLIC_REVENUECAT_API_KEY=your_sandbox_api_key
```

## 2. 功能测试清单

### 2.1 基础功能测试

#### ✅ 支付系统初始化
- [ ] 应用启动时RevenueCat正确初始化
- [ ] 产品列表正常加载
- [ ] 会员状态正确显示

**测试步骤：**
1. 启动应用
2. 检查控制台日志：`💰 [MobilePayment] RevenueCat初始化成功`
3. 进入会员页面，确认产品列表显示

#### ✅ 产品展示
- [ ] Premium月付/年付产品正确显示
- [ ] Pro月付/年付产品正确显示
- [ ] 价格信息正确
- [ ] 功能权益列表正确

**测试步骤：**
1. 打开支付模态框
2. 检查产品信息是否与App Store Connect配置一致
3. 验证价格显示是否正确

#### ✅ 购买流程
- [ ] 点击购买按钮触发Apple支付界面
- [ ] 使用沙盒账户完成支付
- [ ] 支付成功后会员状态更新
- [ ] 权益正确激活

**测试步骤：**
1. 选择Premium月付产品
2. 点击"立即购买"
3. 在Apple支付界面登录沙盒账户
4. 完成支付流程
5. 验证会员状态更新为Premium

### 2.2 高级功能测试

#### ✅ 恢复购买
- [ ] 删除应用重新安装
- [ ] 点击"恢复购买"
- [ ] 会员状态正确恢复

**测试步骤：**
1. 完成一次购买
2. 删除应用并重新安装
3. 点击"恢复购买"按钮
4. 验证会员状态恢复

#### ✅ 订阅管理
- [ ] 升级订阅（Premium → Pro）
- [ ] 降级订阅（Pro → Premium）
- [ ] 取消订阅
- [ ] 重新激活订阅

**测试步骤：**
1. 购买Premium月付
2. 升级到Pro月付
3. 在设置中取消订阅
4. 重新激活订阅

#### ✅ 权益验证
- [ ] Premium权益正确激活
- [ ] Pro权益正确激活
- [ ] 过期后权益正确停用

**测试功能：**
- 无限记账记录
- 高级数据分析
- 云端同步
- AI智能分析（Pro）
- 投资追踪（Pro）

### 2.3 错误处理测试

#### ✅ 网络错误
- [ ] 无网络时的错误提示
- [ ] 网络恢复后的重试机制

#### ✅ 支付错误
- [ ] 用户取消支付的处理
- [ ] 支付失败的错误提示
- [ ] 重复购买的处理

#### ✅ 系统错误
- [ ] RevenueCat服务异常的处理
- [ ] 后端同步失败的处理

## 3. 自动化测试

### 3.1 单元测试

运行支付相关的单元测试：

```bash
cd apps/web
npm test -- --testPathPattern=payment
```

### 3.2 集成测试

```bash
# 测试支付服务初始化
npm run test:payment-init

# 测试产品加载
npm run test:product-loading

# 测试会员状态同步
npm run test:membership-sync
```

## 4. 测试数据验证

### 4.1 RevenueCat Dashboard检查

1. 登录RevenueCat Dashboard
2. 检查以下数据：
   - 测试用户出现在客户列表中
   - 购买事件正确记录
   - 订阅状态正确显示

### 4.2 应用日志检查

关键日志信息：
```
💰 [MobilePayment] RevenueCat初始化成功
💰 [MobilePayment] 购买成功: {productId}
💰 [MobilePayment] 客户信息已同步到后端
📱 [SyncPurchase] 收到购买同步请求
📨 [RevenueCatWebhook] 收到事件: INITIAL_PURCHASE
```

### 4.3 数据库验证

检查以下数据表：
- 用户会员状态更新
- 购买历史记录
- 权益激活记录
- 同步日志记录

## 5. 性能测试

### 5.1 初始化性能
- [ ] 应用启动时间 < 3秒
- [ ] 支付系统初始化时间 < 2秒
- [ ] 产品加载时间 < 1秒

### 5.2 购买流程性能
- [ ] 购买按钮响应时间 < 500ms
- [ ] 支付完成后状态更新时间 < 3秒
- [ ] 权益激活时间 < 2秒

## 6. 兼容性测试

### 6.1 iOS版本兼容性
- [ ] iOS 14.0+
- [ ] iOS 15.0+
- [ ] iOS 16.0+
- [ ] iOS 17.0+

### 6.2 设备兼容性
- [ ] iPhone SE (第二代)
- [ ] iPhone 12/13/14/15系列
- [ ] iPad (第九代)
- [ ] iPad Pro

## 7. 测试报告模板

### 测试执行记录

| 测试项目 | 状态 | 备注 |
|---------|------|------|
| 支付系统初始化 | ✅ | 正常 |
| 产品列表加载 | ✅ | 正常 |
| Premium购买 | ✅ | 正常 |
| Pro购买 | ✅ | 正常 |
| 恢复购买 | ✅ | 正常 |
| 订阅升级 | ✅ | 正常 |
| 订阅取消 | ✅ | 正常 |
| 权益验证 | ✅ | 正常 |
| 错误处理 | ✅ | 正常 |

### 发现的问题

| 问题描述 | 严重程度 | 状态 | 解决方案 |
|---------|----------|------|----------|
| 示例问题 | 中等 | 已修复 | 示例解决方案 |

## 8. 测试工具

### 8.1 调试工具

在开发环境中，可以使用以下调试工具：

```javascript
// 在浏览器控制台中访问调试信息
window.__ZHIWEIJZ_DEBUG__.payment.getCustomerInfo()
window.__ZHIWEIJZ_DEBUG__.payment.getOfferings()
```

### 8.2 测试脚本

```bash
# 运行完整测试套件
npm run test:payment-full

# 运行快速测试
npm run test:payment-quick

# 生成测试报告
npm run test:payment-report
```

## 9. 常见测试问题

### Q: 沙盒购买失败
A: 确保使用正确的沙盒测试账户，检查产品ID是否正确。

### Q: 产品列表为空
A: 检查RevenueCat配置，确保产品已正确导入。

### Q: 会员状态未更新
A: 检查后端同步逻辑，验证webhook是否正常工作。

### Q: 恢复购买失败
A: 确保使用相同的Apple ID，检查RevenueCat用户ID映射。

## 10. 测试完成标准

所有测试项目必须通过，包括：
- ✅ 基础功能测试 (100%)
- ✅ 高级功能测试 (100%)
- ✅ 错误处理测试 (100%)
- ✅ 性能测试 (通过)
- ✅ 兼容性测试 (通过)

测试完成后，可以进行生产环境部署。
