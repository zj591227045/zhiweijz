# LLM健康检查统一调度器迁移

## 问题描述

在启用 `USE_UNIFIED_SCHEDULER=true` 后，LLM提供商健康检查出现重复执行的问题：

1. **旧的独立健康检查服务**仍在运行（虽然定时器被禁用）
2. **新的统一调度器**中没有注册LLM健康检查任务
3. 导致日志污染，特别是"豆包1.5Lite"的错误反复出现

## 根本原因

### 1. 单例过早初始化
```typescript
// llm-provider-service.ts (修改前)
public multiProviderService: MultiProviderLLMService = MultiProviderLLMService.getInstance();
```

这行代码在类属性初始化时就创建了单例，导致：
- 即使不使用多提供商功能，单例也会被创建
- 单例创建时会调用 `initializeHealthCheck()`
- 虽然统一调度器模式下跳过了定时器，但可能触发其他初始化逻辑

### 2. 任务未注册到统一调度器
`register-internal-tasks.ts` 中没有注册LLM健康检查任务，导致统一调度器无法管理该任务。

## 解决方案

### 1. 延迟加载单例（修复过早初始化）

**修改文件**: `server/src/ai/llm/llm-provider-service.ts`

```typescript
// 修改前
public multiProviderService: MultiProviderLLMService = MultiProviderLLMService.getInstance();

// 修改后
private _multiProviderService?: MultiProviderLLMService;

public get multiProviderService(): MultiProviderLLMService {
  if (!this._multiProviderService) {
    this._multiProviderService = MultiProviderLLMService.getInstance();
  }
  return this._multiProviderService;
}
```

**效果**: 只有在真正使用时才创建单例，避免不必要的初始化。

### 2. 注册LLM健康检查到统一调度器

**修改文件**: `server/src/admin/services/register-internal-tasks.ts`

添加任务注册：
```typescript
// 10. LLM提供商健康检查任务
internalTaskRegistry.register({
  key: 'llm-provider-health-check',
  name: 'LLM提供商健康检查',
  description: '检查所有LLM提供商的健康状态，更新可用性信息',
  suggestedCron: '*/5 * * * *', // 每5分钟执行一次
  execute: async () => {
    console.log('🔍 开始执行LLM提供商健康检查...');
    const multiProviderService = MultiProviderLLMService.getInstance();
    await multiProviderService.triggerHealthCheck();
    console.log('✅ LLM提供商健康检查完成');
  }
});
```

### 3. 优化日志输出

**修改文件**: `server/src/ai/llm/multi-provider-service.ts`

- 统一日志前缀为 `[LLM健康检查]`
- 移除重复的错误日志
- 添加健康状态汇总

**修改前**:
```
执行LLM提供商健康检查...
提供商 豆包1.5Lite 健康检查失败: 模型不存在或接入点ID无效
提供商 豆包1.5Lite 健康检查: ✗ 错误: 模型不存在或接入点ID无效
健康检查完成，状态已保存到数据库
```

**修改后**:
```
[LLM健康检查] 开始检查所有提供商...
[LLM健康检查] 豆包1.5Lite: ✗ 异常 - 模型不存在或接入点ID无效
[LLM健康检查] DeepSeek: ✓ 健康
[LLM健康检查] 完成 - 2/3 个提供商健康
```

## 部署步骤

### 1. 更新代码
```bash
# 代码已通过Git更新，无需额外操作
git pull
```

### 2. 检查迁移状态（可选）
```bash
# 查看当前版本和待执行迁移
node server/migrations/migration-manager.js status

# 输出示例：
# 当前版本: 1.8.10
# 目标版本: 1.9.0
# 待执行迁移: add-llm-health-check-task
```

### 3. 执行数据库迁移
```bash
# 方式1: 使用项目迁移管理器（推荐）
node server/migrations/migration-manager.js migrate

# 方式2: 直接使用psql执行
psql -U your_user -d your_database -f server/migrations/incremental/add-llm-health-check-task.sql

# 方式3: Docker环境下执行
docker exec -i zhiweijz-postgres psql -U zhiweijz -d zhiweijz < server/migrations/incremental/add-llm-health-check-task.sql
```

### 4. 重启服务
```bash
# Docker环境
cd docker
./stop.sh
./start.sh

# 本地开发环境
npm run dev
```

### 5. 验证
查看日志，确认：
1. 启动时显示: `[MultiProviderLLM] 统一调度器模式 - 健康检查由计划任务管理`
2. 每5分钟只执行一次健康检查
3. 日志格式统一，无重复输出

```bash
# 查看计划任务列表（应该看到9个内部任务）
docker logs zhiweijz-server 2>&1 | grep "内部任务注册"

# 查看健康检查执行日志
docker logs zhiweijz-server 2>&1 | grep "LLM健康检查"
```

## 向后兼容性

### 传统模式（USE_UNIFIED_SCHEDULER=false）
- 独立健康检查定时器仍然正常工作
- 启动时显示: `[MultiProviderLLM] 传统模式 - 启动独立健康检查定时器`
- 无需任何配置更改

### 统一调度器模式（USE_UNIFIED_SCHEDULER=true）
- 独立定时器被禁用
- 健康检查由计划任务管理
- 需要在数据库中添加任务记录

## 技术细节

### 为什么使用延迟加载？

**问题**: 类属性初始化时创建单例
```typescript
public multiProviderService = MultiProviderLLMService.getInstance();
```

这会导致：
1. 即使不使用多提供商功能，单例也会被创建
2. 单例构造函数中的所有初始化逻辑都会执行
3. 违反"按需加载"原则

**解决**: 使用getter延迟加载
```typescript
private _multiProviderService?: MultiProviderLLMService;

public get multiProviderService(): MultiProviderLLMService {
  if (!this._multiProviderService) {
    this._multiProviderService = MultiProviderLLMService.getInstance();
  }
  return this._multiProviderService;
}
```

这样：
1. 只有在真正访问时才创建单例
2. 减少不必要的资源消耗
3. 避免启动时的副作用

### 为什么移除重复日志？

**问题**: `checkProviderHealth()` 和 `performHealthCheck()` 都输出错误日志

**解决**: 只在 `performHealthCheck()` 中统一输出，避免重复

## 相关文件

### 代码文件
- `server/src/ai/llm/llm-provider-service.ts` - 延迟加载修复
- `server/src/ai/llm/multi-provider-service.ts` - 健康检查逻辑优化
- `server/src/admin/services/register-internal-tasks.ts` - 任务注册

### 数据库迁移
- `server/migrations/incremental/add-llm-health-check-task.sql` - 数据库迁移脚本

### 文档
- `docs/20251212-LLM健康检查统一调度器迁移.md` - 本文档

## 测试建议

1. **启动测试**: 确认启动日志正确
2. **定时执行测试**: 观察5分钟后是否自动执行
3. **手动触发测试**: 通过管理后台手动执行任务
4. **错误处理测试**: 故意配置错误的API密钥，确认错误日志格式正确
5. **模式切换测试**: 切换 `USE_UNIFIED_SCHEDULER` 值，确认两种模式都正常工作
