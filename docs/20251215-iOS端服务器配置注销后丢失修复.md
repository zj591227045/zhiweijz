# iOS端服务器配置注销后丢失修复

## 问题描述

iOS端用户配置了自定义服务器后可以正常登录，但注销后重新登录时，应用又连接回了官方服务器，自定义服务器配置丢失了。这是错误的行为，服务器配置应该是全局设置，不应该因为用户注销而被清除。

## 问题分析

### 根本原因分析
经过深入分析，发现了两个关键问题：

1. **Web端缓存清理过于激进**：`performLogoutCleanup()` 函数清除了所有localStorage缓存，包括服务器配置
2. **zustand persist配置问题**：`skipHydration: true` 可能导致移动端配置恢复失败

### 数据流分析
1. 用户配置自定义服务器 → 保存到 `server-config-storage`
2. 用户注销 → 调用清理逻辑
3. 清理函数清除localStorage项或配置恢复失败
4. `server-config-storage` 被误清除或无法正确恢复
5. 重新登录时回到默认官方服务器

### 平台架构分析
- **Web端**：直接运行React应用，使用localStorage
- **iOS端**：Capacitor应用，运行Web代码，但可能有不同的存储行为
- **Android端**：同样是Capacitor应用，可能存在相同问题

## 修复方案

### 核心思路
服务器配置和用户认证是两个独立的概念，不应该耦合。服务器配置应该被视为全局设置，在用户注销后仍然保留。

### 修复1：Web端缓存清理优化
修改 `apps/web/src/utils/cache-utils.ts` 中的 `shouldRemoveKey` 函数：

```typescript
/**
 * 判断是否应该清除某个localStorage键
 */
function shouldRemoveKey(key: string): boolean {
  // 永远不清除的配置（全局设置）
  const preservePatterns = [
    'server-config', // 服务器配置应该在注销后保留
    'theme', // 主题设置应该保留
  ];

  // 如果是需要保留的配置，直接返回false
  if (preservePatterns.some((pattern) => key.includes(pattern))) {
    return false;
  }

  // 需要清除的用户数据模式
  const clearPatterns = [
    'auth',
    'user',
    'account-book',
    'budget',
    'transaction',
    'category',
    'family',
    'statistics',
    'dashboard',
    'ai-services',
    'llm-cache',
  ];

  return clearPatterns.some((pattern) => key.includes(pattern));
}
```

### 修复2：zustand persist配置优化
修改 `apps/web/src/store/server-config-store.ts` 中的persist配置：

```typescript
{
  name: 'server-config-storage',
  // 只在非Docker环境中持久化配置
  skipHydration: false, // 允许hydration，确保移动端正确恢复配置
}
```

### 修改要点
1. **明确分离**：将配置分为"保留配置"和"清除配置"两类
2. **优先级明确**：保留配置优先级高于清除配置
3. **恢复机制**：启用hydration确保移动端配置正确恢复
4. **跨平台一致性**：确保Web端和移动端行为一致

## 测试验证

### 测试场景1：自定义服务器配置保留
1. 打开应用，进入服务器设置
2. 选择"自定义服务器"，输入自定义地址
3. 保存配置并登录
4. 注销账户
5. **预期结果**：重新进入设置页面，自定义服务器配置仍然存在

### 测试场景2：用户数据正确清除
1. 登录账户，产生一些用户数据（账本、交易等）
2. 注销账户
3. **预期结果**：用户相关数据被清除，但服务器配置和主题设置保留

### 测试场景3：跨平台一致性
1. 在Web端、iOS端和Android端分别测试相同场景
2. **预期结果**：三个平台的行为一致，都保留服务器配置

### 测试场景4：配置恢复验证
1. 配置自定义服务器后关闭应用
2. 重新打开应用
3. **预期结果**：服务器配置正确恢复，无需重新配置

## 影响范围

### 正面影响
- ✅ 修复iOS端和Android端服务器配置丢失问题
- ✅ 提升用户体验，无需重复配置服务器
- ✅ 统一Web端和移动端的行为逻辑
- ✅ 明确区分全局配置和用户数据
- ✅ 改善移动端配置恢复机制

### 风险评估
- 🟢 **低风险**：只是调整了缓存清理逻辑和persist配置
- 🟢 **向后兼容**：不会破坏现有用户的使用习惯
- 🟢 **数据安全**：用户敏感数据仍然正确清除
- 🟡 **需要测试**：移动端配置恢复需要充分测试

## 代码质量评估

【品味评分】
🟢 好品味

【改进方向】
- 消除了"注销时清除服务器配置"这个特殊情况
- 明确分离了全局配置和用户数据的概念
- 代码逻辑更加清晰，易于理解和维护

## Android端问题确认

基于架构分析，Android端使用相同的Capacitor架构，因此**存在相同的问题**：
- 使用相同的Web代码和存储逻辑
- 可能受到相同的`skipHydration`配置影响
- 注销时可能同样丢失服务器配置

**建议**：在iOS端修复验证后，同步测试Android端的行为。

## 总结

这个修复解决了一个真实的跨平台用户体验问题。通过两个关键修改：

1. **缓存清理优化**：明确区分全局配置和用户数据
2. **配置恢复优化**：启用hydration确保移动端正确恢复

确保服务器配置在用户注销后仍然保留，同时保持用户敏感数据的正确清理。修复方案简单直接，风险低，符合"Never break userspace"的原则。

**关键洞察**：移动端应用的存储行为可能与Web端不同，需要特别关注配置恢复机制。