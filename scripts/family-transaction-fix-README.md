# å®¶åº­è´¦æœ¬äº¤æ˜“è®°å½•ä¿®å¤è„šæœ¬ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

è¿™äº›è„šæœ¬ç”¨äºä¿®å¤å®¶åº­è´¦æœ¬ä¸­äº¤æ˜“è®°å½•çš„å®¶åº­æˆå‘˜IDå½’å±é—®é¢˜ã€‚å½“å¯¼å…¥çš„äº¤æ˜“è®°å½•çš„å®¶åº­æˆå‘˜IDéƒ½æŒ‡å‘å¯¼å…¥è€…æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›è„šæœ¬æ ¹æ®é¢„ç®—IDæ‰¾åˆ°æ­£ç¡®çš„å®¶åº­æˆå‘˜IDå¹¶è¿›è¡Œä¿®å¤ã€‚

## è„šæœ¬æ–‡ä»¶

- `analyze-family-transactions.js` - åˆ†æå®¶åº­è´¦æœ¬äº¤æ˜“è®°å½•å½’å±æƒ…å†µ
- `fix-family-member-ids.js` - ä¿®å¤å®¶åº­æˆå‘˜IDå½’å±é—®é¢˜
- `fix-budget-family-associations.js` - ä¿®å¤é¢„ç®—çš„å®¶åº­å…³è”é—®é¢˜
- `comprehensive-family-fix.js` - ç»¼åˆä¿®å¤é¢„ç®—å’Œäº¤æ˜“çš„å®¶åº­å…³è”é—®é¢˜ï¼ˆæ¨èï¼‰

## Dockerç¯å¢ƒä½¿ç”¨æ–¹æ³•

### æ¨èæµç¨‹ï¼ˆä½¿ç”¨ç»¼åˆä¿®å¤è„šæœ¬ï¼‰

```bash
# 1. è¿›å…¥å®¹å™¨
docker exec -it <container_name> bash

# 2. åˆ†ææ•°æ®ï¼ˆäº†è§£é—®é¢˜èŒƒå›´ï¼‰
node scripts/analyze-family-transactions.js <accountBookId>

# 3. ç»¼åˆé¢„è§ˆä¿®å¤ï¼ˆé¢„ç®—+äº¤æ˜“ï¼‰
node scripts/comprehensive-family-fix.js <accountBookId> preview

# 4. æ‰§è¡Œç»¼åˆä¿®å¤
node scripts/comprehensive-family-fix.js <accountBookId> fix
```

### åˆ†æ­¥ä¿®å¤æµç¨‹ï¼ˆå¦‚éœ€ç²¾ç»†æ§åˆ¶ï¼‰

```bash
# 1. åˆ†ææ•°æ®
node scripts/analyze-family-transactions.js <accountBookId>

# 2. ä¿®å¤é¢„ç®—å…³è”
node scripts/fix-budget-family-associations.js preview
node scripts/fix-budget-family-associations.js fix

# 3. ä¿®å¤äº¤æ˜“å½’å±
node scripts/fix-family-member-ids.js <accountBookId> preview
node scripts/fix-family-member-ids.js <accountBookId> fix
```

## æœ¬åœ°ç¯å¢ƒä½¿ç”¨æ–¹æ³•

```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /path/to/zhiweijz

# åˆ†ææ•°æ®
node scripts/analyze-family-transactions.js <accountBookId>

# é¢„è§ˆä¿®å¤
node scripts/fix-family-member-ids.js <accountBookId> preview

# æ‰§è¡Œä¿®å¤
node scripts/fix-family-member-ids.js <accountBookId> fix
```

## è·å–è´¦æœ¬ID

### æ–¹æ³•1ï¼šé€šè¿‡æ•°æ®åº“æŸ¥è¯¢
```sql
-- æŸ¥è¯¢æ‰€æœ‰å®¶åº­è´¦æœ¬
SELECT id, name, family_id FROM account_books WHERE type = 'FAMILY';

-- æŸ¥è¯¢ç‰¹å®šå®¶åº­çš„è´¦æœ¬
SELECT ab.id, ab.name, f.name as family_name 
FROM account_books ab 
JOIN families f ON ab.family_id = f.id 
WHERE ab.type = 'FAMILY' AND f.name LIKE '%å®¶åº­åç§°%';
```

### æ–¹æ³•2ï¼šé€šè¿‡åº”ç”¨ç•Œé¢
1. ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
2. è¿›å…¥å®¶åº­ç®¡ç†é¡µé¢
3. æŸ¥çœ‹è´¦æœ¬è¯¦æƒ…ï¼ŒURLä¸­åŒ…å«è´¦æœ¬ID

## ä¿®å¤é€»è¾‘è¯´æ˜

è„šæœ¬ä¼šæ ¹æ®ä»¥ä¸‹é€»è¾‘ä¿®å¤å®¶åº­æˆå‘˜IDï¼š

1. **é¢„ç®—å½’å±ä¼˜å…ˆ**ï¼š
   - æ£€æŸ¥äº¤æ˜“çš„é¢„ç®—ID
   - æ ¹æ®é¢„ç®—çš„æ‰€æœ‰è€…ç¡®å®šæ­£ç¡®çš„å®¶åº­æˆå‘˜ID

2. **ç»Ÿä¸€å¤„ç†é€»è¾‘**ï¼š
   - æ—§æ¶æ„ï¼šé¢„ç®—ç›´æ¥å…³è”å®¶åº­æˆå‘˜ID
   - æ–°æ¶æ„ï¼šé¢„ç®—å…³è”ç”¨æˆ·IDï¼Œé€šè¿‡ç”¨æˆ·IDæŸ¥æ‰¾å®¶åº­æˆå‘˜ID

3. **æ•°æ®éªŒè¯**ï¼š
   - åªå¤„ç†æœ‰é¢„ç®—IDçš„äº¤æ˜“
   - è·³è¿‡å·²ç»æ­£ç¡®çš„è®°å½•
   - è®°å½•å¤„ç†å¤±è´¥çš„æƒ…å†µ

## è¾“å‡ºç¤ºä¾‹

### åˆ†æè„šæœ¬è¾“å‡ºï¼š
```
ğŸ” åˆ†æè´¦æœ¬ abc123 çš„äº¤æ˜“è®°å½•å½’å±æƒ…å†µ...
âœ… å®¶åº­è´¦æœ¬: æˆ‘çš„å®¶åº­è´¦æœ¬
   å®¶åº­ID: family123

ğŸ‘¥ å®¶åº­æˆå‘˜åˆ—è¡¨:
   member1: å¼ ä¸‰ (ç”¨æˆ·: å¼ ä¸‰, æ™®é€š)
   member2: æå›› (ç”¨æˆ·: æå››, æ‰˜ç®¡)

ğŸ“Š äº¤æ˜“è®°å½•ç»Ÿè®¡:
   æ€»äº¤æ˜“æ•°: 150
   æœ‰é¢„ç®—ID: 120
   æœ‰å®¶åº­æˆå‘˜ID: 150

âš ï¸  æ½œåœ¨é—®é¢˜æ£€æŸ¥:
   ğŸ”´ æœ‰ 45 æ¡è®°å½•æœ‰é¢„ç®—ä½†å®¶åº­æˆå‘˜IDä¸æ­£ç¡®
```

### é¢„è§ˆæ¨¡å¼è¾“å‡ºï¼š
```
ğŸ” [é¢„è§ˆ] äº¤æ˜“ abc12345: member1 -> member2
    é‡‘é¢: 50.00, æ—¥æœŸ: 2024-01-15
    é¢„ç®—: æå››çš„é¤é¥®é¢„ç®— (æå››)

ğŸ“ˆ é¢„è§ˆç»“æœç»Ÿè®¡:
ğŸ” éœ€è¦ä¿®å¤: 45 æ¡
âœ“  å·²æ­£ç¡®è·³è¿‡: 75 æ¡

ğŸ’¡ è¦æ‰§è¡Œå®é™…ä¿®å¤ï¼Œè¯·è¿è¡Œ:
   node scripts/fix-family-member-ids.js abc123 fix
```

### ä¿®å¤æ¨¡å¼è¾“å‡ºï¼š
```
âœ… ä¿®å¤äº¤æ˜“ abc12345: member1 -> member2

ğŸ“ˆ ä¿®å¤ç»“æœç»Ÿè®¡:
âœ… æˆåŠŸä¿®å¤: 45 æ¡
âœ“  å·²æ­£ç¡®è·³è¿‡: 75 æ¡
âŒ å¤„ç†å¤±è´¥: 0 æ¡

ğŸ‰ ä¿®å¤å®Œæˆï¼å…±å¤„ç† 120 æ¡è®°å½•
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šæ‰§è¡Œä¿®å¤å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
3. **é¢„è§ˆæ¨¡å¼**ï¼šå§‹ç»ˆå…ˆè¿è¡Œé¢„è§ˆæ¨¡å¼ç¡®è®¤ä¿®å¤å†…å®¹
4. **é€æ­¥æ‰§è¡Œ**ï¼šæŒ‰ç…§æ¨èæ­¥éª¤é€æ­¥æ‰§è¡Œ

## å¸¸è§é—®é¢˜

### Q: è„šæœ¬æç¤º"è´¦æœ¬ä¸å­˜åœ¨"
A: æ£€æŸ¥è´¦æœ¬IDæ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿æ˜¯å®Œæ•´çš„UUIDæ ¼å¼

### Q: è„šæœ¬æç¤º"ä¸æ˜¯å®¶åº­è´¦æœ¬"
A: ç¡®è®¤è´¦æœ¬ç±»å‹ä¸ºFAMILYï¼Œä¸ªäººè´¦æœ¬ä¸éœ€è¦ä¿®å¤

### Q: ä¿®å¤åç»Ÿè®¡æ•°æ®ä¸å¯¹
A: é‡æ–°è¿è¡Œåˆ†æè„šæœ¬æ£€æŸ¥ï¼Œå¯èƒ½éœ€è¦åˆ·æ–°åº”ç”¨ç¼“å­˜

### Q: Dockerå®¹å™¨ä¸­æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶
A: ç¡®ä¿è„šæœ¬æ–‡ä»¶å·²æ­£ç¡®å¤åˆ¶åˆ°å®¹å™¨ä¸­ï¼Œæ£€æŸ¥æ–‡ä»¶è·¯å¾„

## æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æä¾›ï¼š
- å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
- è´¦æœ¬ID
- åˆ†æè„šæœ¬çš„è¾“å‡ºç»“æœ
- æ•°æ®åº“å’Œç¯å¢ƒä¿¡æ¯

## ç›¸å…³æ–‡æ¡£

- [å®¶åº­æˆå‘˜ç»Ÿè®¡é€»è¾‘é‡æ„æ–‡æ¡£](../docs/backend/member-statistics-refactor.md)
- [äº¤æ˜“åˆ›å»ºç«¯ç‚¹å®¡è®¡æŠ¥å‘Š](../docs/backend/transaction-creation-endpoints-audit.md)
