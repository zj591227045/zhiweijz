# 预算结转历史修复指南

## 问题描述

对于启用了预算结转的个人预算（包含普通用户以及托管用户），在跨月生成新预算时存在以下问题：
1. 没有生成预算结转历史记录
2. 最新个人预算的结转金额可能不正确

## 解决方案

### 1. 代码修复
已修改 `createBudgetForPeriod` 方法，在创建新预算时自动为上一个预算创建结转历史记录。

### 2. 数据修复脚本
提供了专门的修复脚本来处理历史数据中缺失的结转历史记录。

## 使用步骤

### 1. 托管成员预算修复
```bash
# 复制脚本到容器
docker cp fix-custodial-budgets.js zhiweijz-backend:/tmp/

# 预览模式
docker exec -it zhiweijz-backend node /tmp/fix-custodial-budgets.js --dry-run

# 修复模式
docker exec -it zhiweijz-backend node /tmp/fix-custodial-budgets.js
```

### 2. 预算结转历史修复
```bash
# 复制脚本到容器
docker cp fix-budget-rollover-history.js zhiweijz-backend:/tmp/

# 预览模式
docker exec -it zhiweijz-backend node /tmp/fix-budget-rollover-history.js --dry-run

# 修复模式
docker exec -it zhiweijz-backend node /tmp/fix-budget-rollover-history.js
```

### 3. 清理临时文件
```bash
docker exec -it zhiweijz-backend rm /tmp/fix-custodial-budgets.js
docker exec -it zhiweijz-backend rm /tmp/fix-budget-rollover-history.js
```

## 修复内容

### 托管成员预算修复
- 查找所有托管成员
- 检查是否存在当前月份预算
- 基于最新预算创建当前月份预算
- 正确处理预算结转逻辑

### 预算结转历史修复
- 查找所有启用了结转的预算
- 检查是否缺失结转历史记录
- 重新计算并验证结转金额
- 生成缺失的历史记录
- 更新不正确的结转金额

## 脚本特点

### 安全性
- 支持预览模式，可先查看会创建/修改什么
- 自动检查避免重复创建
- 详细的执行日志
- 执行后自动验证结果

### 智能处理
- 按用户分组处理预算
- 按时间顺序处理预算链
- 自动计算结转金额
- 正确处理正数和负数结转

## 输出示例

### 托管成员预算修复
```
=== 托管成员预算修复脚本 ===
模式: 预览模式（不会修改数据）

找到 2 个托管成员

托管成员: 小明
  账本: 张家账本
    📋 基于预算: 小明零花钱 (2024-11-30)
    结转: 预算100 + 上次0 - 支出50 = 50
    [预览] 小明零花钱 - 金额:100 结转:50

=== 修复完成 ===
处理数量: 2
预览创建: 1
跳过数量: 1
```

### 预算结转历史修复
```
=== 预算结转历史修复脚本 ===
模式: 预览模式（不会修改数据）

查找所有启用了结转的预算...
找到 15 个启用了结转的预算

处理用户: 张三 (3 个预算)
  预算: 生活费 (2024-10-31)
    支出: 800, 计算结转: 200
    [预览] 结转历史: 2024-10 - 余额结转 200
  预算: 生活费 (2024-11-30)
    支出: 950, 计算结转: 250
    ✅ 下个预算结转金额正确

=== 修复完成 ===
处理的预算数: 15
预览创建的历史记录数: 8
预览更新的结转金额数: 2
```

## 验证修复结果

修复完成后，可以通过以下SQL查询验证：

### 1. 检查托管成员预算
```sql
SELECT 
  fm.name as 托管成员,
  ab.name as 账本,
  b.name as 预算名称,
  b.start_date as 开始日期,
  b.end_date as 结束日期,
  b.amount as 预算金额,
  b.rollover_amount as 结转金额
FROM family_members fm
JOIN account_books ab ON fm.family_id = ab.family_id
JOIN budgets b ON fm.id = b.family_member_id AND ab.id = b.account_book_id
WHERE fm.is_custodial = true
  AND b.start_date >= DATE_TRUNC('month', CURRENT_DATE)
ORDER BY fm.name, b.start_date;
```

### 2. 检查结转历史记录
```sql
SELECT 
  b.name as 预算名称,
  bh.period as 期间,
  bh.type as 类型,
  bh.amount as 结转金额,
  bh.description as 描述,
  bh.created_at as 创建时间
FROM budget_histories bh
JOIN budgets b ON bh.budget_id = b.id
WHERE bh.type IN ('SURPLUS', 'DEFICIT')
ORDER BY bh.period DESC, b.name;
```

## 注意事项

1. **备份数据**：建议在执行前备份数据库
2. **预览模式**：首次运行建议使用 `--dry-run` 参数
3. **执行顺序**：建议先执行托管成员预算修复，再执行结转历史修复
4. **权限检查**：确保有足够的数据库访问权限
5. **监控日志**：执行过程中注意观察输出日志

## 后续预防

修复完成后，新创建的预算将自动：
1. 正确计算和设置结转金额
2. 自动创建结转历史记录
3. 确保预算链的连续性和正确性
