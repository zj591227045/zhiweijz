# 统一定时任务调度器 - 快速启动

## 🚀 3分钟快速启动

### 1️⃣ 运行数据库迁移

```bash
cd server
npm run migrate:upgrade
```

### 2️⃣ 启用统一调度器

编辑 `server/.env`，添加：

```bash
USE_UNIFIED_SCHEDULER=true
```

### 3️⃣ 重启服务器

```bash
npm run dev
```

### 4️⃣ 在管理界面启用任务

1. 访问：`http://localhost:3000/admin`
2. 进入"计划任务管理"
3. 启用需要的任务

## 📋 已注册的内部任务

| 任务名称 | 任务Key | Cron表达式 | 执行频率 |
|---------|---------|-----------|---------|
| 用户注销请求处理 | `user-deletion-check` | `0 0 * * *` | 每天0点 |
| 会员到期检查 | `membership-expiry-check` | `30 * * * *` | 每小时30分 |
| 微信媒体文件清理 | `wechat-media-cleanup` | `0 * * * *` | 每小时 |
| 数据聚合 | `data-aggregation-manual` | `0 * * * *` | 每小时 |
| 对象存储临时文件清理 | `storage-temp-files-cleanup` | `0 2 * * *` | 每天2点 |
| 预算结转和创建 | `budget-rollover-and-creation` | `0 2 1 * *` | 每月1号2点 |

## 🔄 如何回滚

如果遇到问题，可以随时回滚到传统模式：

1. 编辑 `server/.env`，设置：
   ```bash
   USE_UNIFIED_SCHEDULER=false
   ```
   或删除该环境变量

2. 重启服务器：
   ```bash
   npm run dev
   ```

## ✅ 验证任务执行

### 方法1：查看服务器日志

```bash
# 查看任务注册日志
[内部任务注册表] 注册任务: user-deletion-check - 用户注销请求处理
[内部任务注册表] 注册任务: membership-expiry-check - 会员到期检查
...

# 查看任务执行日志
[计划任务服务] 定时触发任务: 会员到期检查
[内部任务注册表] 开始执行任务: 会员到期检查 (membership-expiry-check)
[内部任务注册表] 任务执行成功: 会员到期检查 (耗时: 1234ms)
```

### 方法2：查看管理界面

访问"计划任务管理" -> "执行日志"，可以看到：
- 执行时间
- 执行状态（成功/失败）
- 执行时长
- 输出日志
- 错误信息（如果有）

### 方法3：手动执行任务

在任务详情页点击"立即执行"，观察执行结果。

## 🎯 建议启用顺序

为了安全起见，建议按以下顺序逐个启用任务：

1. **预算结转和创建**（低频，每月执行）
   - 启用后等待下个月1号观察执行情况

2. **对象存储临时文件清理**（低频，每天执行）
   - 启用后等待第二天凌晨2点观察执行情况

3. **用户注销请求处理**（低频，每天执行）
   - 启用后等待第二天凌晨0点观察执行情况

4. **微信媒体文件清理**（中频，每小时执行）
   - 启用后等待1小时观察执行情况

5. **数据聚合**（中频，每小时执行）
   - 启用后等待1小时观察执行情况

6. **会员到期检查**（高频，每小时执行）
   - 启用后等待30分钟观察执行情况

## ⚠️ 注意事项

1. **不要同时运行两种模式**
   - 确保 `USE_UNIFIED_SCHEDULER` 只设置为 `true` 或 `false`
   - 避免任务重复执行

2. **逐个启用任务**
   - 不要一次性启用所有任务
   - 每启用一个任务，观察执行情况后再启用下一个

3. **保留执行日志**
   - 执行日志至少保留30天
   - 便于问题追溯和性能分析

4. **定期检查**
   - 每周检查一次执行日志
   - 关注任务执行失败的情况
   - 及时处理异常

## 📚 更多文档

- **详细文档**：`docs/backend/unified-task-scheduler.md`
- **迁移指南**：`server/UNIFIED_SCHEDULER_MIGRATION.md`
- **实现总结**：`TASK_SCHEDULER_IMPLEMENTATION_SUMMARY.md`

## 🆘 常见问题

### Q: 任务未执行？

**检查清单：**
- [ ] 任务是否在管理界面启用？
- [ ] Cron表达式是否正确？
- [ ] 服务器日志是否有错误？
- [ ] 执行日志是否有记录？

### Q: 任务执行失败？

**排查步骤：**
1. 查看执行日志中的错误信息
2. 尝试手动执行任务
3. 检查服务依赖是否正常
4. 查看服务器日志

### Q: 如何添加新任务？

**内部任务：**
1. 在 `register-internal-tasks.ts` 中注册
2. 在管理界面创建任务记录
3. 启用任务

**外部脚本：**
1. 创建脚本文件
2. 在管理界面创建任务
3. 启用任务

## 💡 提示

- 使用统一调度器后，可以在管理界面实时查看所有任务的执行状态
- 可以随时手动触发任务执行，无需等待定时触发
- 可以动态修改Cron表达式，无需重启服务器
- 所有任务执行都有完整的日志记录，便于问题追溯

