# 统一定时任务调度器迁移指南

## 快速开始

### 当前状态

系统现在支持两种定时任务调度模式：

1. **传统模式**（默认）：使用分散的独立任务调度器
2. **统一调度器模式**（推荐）：使用集中管理的计划任务系统

### 迁移到统一调度器

#### 步骤1：运行数据库迁移

```bash
cd server
npm run migrate:upgrade
```

这将创建6个内部任务记录（默认禁用状态）：
- 用户注销请求处理
- 会员到期检查
- 微信媒体文件清理
- 数据聚合
- 对象存储临时文件清理
- 预算结转和创建

#### 步骤2：启用统一调度器

在 `server/.env` 文件中添加：

```bash
USE_UNIFIED_SCHEDULER=true
```

#### 步骤3：重启服务器

```bash
npm run dev  # 开发环境
# 或
npm run start  # 生产环境
```

#### 步骤4：在管理界面启用任务

1. 访问管理后台：`http://your-domain/admin`
2. 进入"计划任务管理"
3. 逐个启用需要的任务

**建议启用顺序：**
1. 预算结转和创建（低频，每月执行）
2. 对象存储临时文件清理（低频，每天执行）
3. 用户注销请求处理（低频，每天执行）
4. 微信媒体文件清理（中频，每小时执行）
5. 数据聚合（中频，每小时执行）
6. 会员到期检查（高频，每小时执行）

#### 步骤5：验证任务执行

- 查看"执行日志"，确认任务正常运行
- 对比新旧系统的执行结果
- 确认无重复执行

## 两种模式对比

### 传统模式

**优点：**
- 无需配置，开箱即用
- 代码简单直接

**缺点：**
- 任务分散，难以统一管理
- 无执行日志，问题难以追溯
- 修改任务时间需要改代码并重启
- 无法动态启用/禁用任务
- 无法手动触发任务执行

### 统一调度器模式

**优点：**
- 集中管理所有定时任务
- 完整的执行日志和错误追踪
- 可通过管理界面动态配置
- 支持手动触发任务执行
- 支持任务执行失败重试
- 便于监控和告警

**缺点：**
- 需要数据库迁移
- 需要在管理界面配置

## 常见问题

### Q: 迁移后旧任务会停止吗？

A: 不会。设置 `USE_UNIFIED_SCHEDULER=true` 后，旧的独立任务调度器会自动停止，只有统一调度器中启用的任务会执行。

### Q: 可以同时运行两种模式吗？

A: 不建议。虽然技术上可行，但会导致任务重复执行。请选择一种模式使用。

### Q: 如何回滚到传统模式？

A: 只需将 `USE_UNIFIED_SCHEDULER` 设置为 `false` 或删除该环境变量，然后重启服务器即可。

### Q: 迁移后发现任务未执行怎么办？

A: 
1. 检查任务是否在管理界面启用
2. 检查Cron表达式是否正确
3. 查看服务器日志和执行日志
4. 尝试手动执行任务，观察错误信息

### Q: 如何添加新的定时任务？

A: 
- **内部任务**：在 `register-internal-tasks.ts` 中注册，然后在管理界面创建
- **外部脚本**：直接在管理界面创建，指定脚本路径

## 技术细节

### 内部任务注册表

所有内部任务都注册在 `internal-task-registry.ts` 中，包括：

```typescript
internalTaskRegistry.register({
  key: 'task-key',           // 任务唯一标识
  name: '任务名称',
  description: '任务描述',
  suggestedCron: '0 0 * * *', // 建议的Cron表达式
  execute: async () => {
    // 任务执行逻辑
  }
});
```

### 任务执行流程

1. 计划任务服务根据Cron表达式触发任务
2. 对于内部任务，调用 `internalTaskRegistry.execute(taskKey)`
3. 对于外部脚本，使用 `spawn` 执行脚本文件
4. 记录执行日志（开始时间、结束时间、输出、错误）
5. 更新任务状态

### 数据库表结构

**scheduled_tasks** - 计划任务表
- `id`: 任务ID
- `name`: 任务名称
- `description`: 任务描述
- `script_type`: 脚本类型（internal/shell/sql/node）
- `script_path`: 脚本路径或内部任务key
- `cron_expression`: Cron表达式
- `is_enabled`: 是否启用

**task_execution_logs** - 执行日志表
- `id`: 日志ID
- `task_id`: 任务ID
- `status`: 执行状态（running/success/failed）
- `start_time`: 开始时间
- `end_time`: 结束时间
- `duration`: 执行时长（毫秒）
- `output`: 标准输出
- `error`: 错误输出
- `triggered_by`: 触发方式（cron/manual）

## 更多信息

详细文档请参考：`docs/backend/unified-task-scheduler.md`

