# é¢„ç®—è‡ªåŠ¨å»¶ç»­åŠŸèƒ½ï¼ˆæ”¯æŒè‡ªå®šä¹‰ç»“è½¬æ—¥æœŸï¼‰

## åŠŸèƒ½æ¦‚è¿°

é¢„ç®—è‡ªåŠ¨å»¶ç»­åŠŸèƒ½è§£å†³äº†ç”¨æˆ·è·¨æœˆåæ— æ³•çœ‹åˆ°é¢„ç®—æ•°æ®çš„é—®é¢˜ã€‚ç³»ç»Ÿé‡‡ç”¨æ··åˆæ–¹æ¡ˆï¼Œç»“åˆè‡ªåŠ¨å»¶ç»­å’Œå®šæ—¶ä»»åŠ¡ä¸¤ç§æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·å§‹ç»ˆèƒ½å¤Ÿçœ‹åˆ°ç›¸åº”çš„é¢„ç®—æ•°æ®ã€‚

**ğŸ‰ æ–°å¢ç‰¹æ€§ï¼šå®Œæ•´æ”¯æŒè‡ªå®šä¹‰ç»“è½¬æ—¥æœŸï¼ˆrefreshDayï¼‰**
- æ”¯æŒ1ã€5ã€10ã€15ã€20ã€25æ—¥ä½œä¸ºé¢„ç®—åˆ·æ–°æ—¥æœŸ
- é¢„ç®—å‘¨æœŸä¸å†å›ºå®šä¸ºæœˆåˆåˆ°æœˆæœ«ï¼Œè€Œæ˜¯ä»refreshDayåˆ°ä¸‹æœˆrefreshDayå‰ä¸€å¤©
- æ”¯æŒè·¨æœˆé¢„ç®—æŸ¥è¯¢å’Œç®¡ç†

## æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨é¢„ç®—å»¶ç»­ï¼ˆä¸»è¦æœºåˆ¶ï¼‰
- **è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·è®¿é—®é¢„ç®—ç›¸å…³é¡µé¢æ—¶
- **å·¥ä½œåŸç†**ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰æœˆä»½çš„é¢„ç®—ï¼Œè‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘çš„å†å²é¢„ç®—å¹¶åˆ›å»ºç¼ºå¤±çš„æœˆä»½é¢„ç®—
- **ä¼˜åŠ¿**ï¼šå®æ—¶å“åº”ï¼Œç”¨æˆ·ä½“éªŒå¥½

### 2. å®šæ—¶ä»»åŠ¡å¤‡ä»½ï¼ˆå¤‡ä»½æœºåˆ¶ï¼‰
- **è§¦å‘æ—¶æœº**ï¼šæ¯æœˆ1å·å‡Œæ™¨è‡ªåŠ¨æ‰§è¡Œ
- **å·¥ä½œåŸç†**ï¼šæ‰¹é‡ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ›å»ºæ–°æœˆä»½é¢„ç®—ï¼Œå¤„ç†é¢„ç®—ç»“è½¬
- **ä¼˜åŠ¿**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ï¼Œé¿å…é—æ¼

### 3. é¢„ç®—ç»“è½¬å¤„ç†
- **è‡ªåŠ¨ç»“è½¬**ï¼šåˆ›å»ºæ–°æœˆä»½é¢„ç®—æ—¶è‡ªåŠ¨å¤„ç†ä¸Šä¸ªæœˆçš„ç»“è½¬
- **å†å²è¿½æº¯**ï¼šæ”¯æŒé‡æ–°è®¡ç®—å†å²è®°è´¦å¯¹ç»“è½¬çš„å½±å“
- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿ç»“è½¬é‡‘é¢è®¡ç®—å‡†ç¡®

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ–¹æ³•

#### `autoCreateMissingBudgets(userId, accountBookId)`
è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„é¢„ç®—å‘¨æœŸï¼ˆæ”¯æŒè‡ªå®šä¹‰refreshDayï¼‰
```typescript
// æŸ¥æ‰¾æœ€è¿‘çš„é¢„ç®—
const latestBudget = await this.findLatestPersonalBudget(userId, accountBookId);
const refreshDay = latestBudget.refreshDay || 1;

// è®¡ç®—éœ€è¦åˆ›å»ºçš„é¢„ç®—å‘¨æœŸ
const periodsToCreate = BudgetDateUtils.calculateMissingPeriods(
  latestEndDate,
  currentDate,
  refreshDay
);

// é€ä¸ªåˆ›å»ºé¢„ç®—å¹¶å¤„ç†ç»“è½¬
for (const period of periodsToCreate) {
  if (latestBudget.rollover) {
    await this.processBudgetRollover(previousBudgetId);
  }
  const newBudget = await this.createBudgetForPeriod(latestBudget, period);
}
```

#### `BudgetDateUtils` å·¥å…·ç±»
ä¸“é—¨å¤„ç†è‡ªå®šä¹‰refreshDayçš„æ—¥æœŸè®¡ç®—
```typescript
// è®¡ç®—é¢„ç®—å‘¨æœŸ
const period = BudgetDateUtils.calculateBudgetPeriod(2024, 6, 15);
// ç»“æœï¼š2024å¹´6æœˆ15æ—¥ - 2024å¹´7æœˆ14æ—¥

// è·å–å½“å‰é¢„ç®—å‘¨æœŸ
const currentPeriod = BudgetDateUtils.getCurrentBudgetPeriod(new Date(), 25);

// è®¡ç®—ç¼ºå¤±çš„é¢„ç®—å‘¨æœŸ
const missingPeriods = BudgetDateUtils.calculateMissingPeriods(
  lastEndDate,
  currentDate,
  refreshDay
);
```

#### `getActiveBudgets(userId, accountBookId)`
è·å–æ´»è·ƒé¢„ç®—ï¼ˆå·²é›†æˆè‡ªåŠ¨å»¶ç»­ï¼‰
```typescript
// å…ˆæŸ¥è¯¢å½“å‰æœˆä»½é¢„ç®—
let budgets = await this.budgetRepository.findActiveBudgets(userId, new Date(), accountBookId);

// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè‡ªåŠ¨åˆ›å»º
if (budgets.length === 0 && accountBookId) {
  await this.autoCreateMissingBudgets(userId, accountBookId);
  budgets = await this.budgetRepository.findActiveBudgets(userId, new Date(), accountBookId);
}
```

### å®šæ—¶ä»»åŠ¡

#### æœˆåº¦é¢„ç®—åˆ›å»ºä»»åŠ¡
```bash
# æ‰‹åŠ¨æ‰§è¡Œ
npm run budget-scheduler

# è®¾ç½®cron jobï¼ˆæ¯æœˆ1å·å‡Œæ™¨2ç‚¹ï¼‰
0 2 1 * * /path/to/node /path/to/project/server/scripts/budget-scheduler.ts
```

#### ä»»åŠ¡å†…å®¹
1. **å¤„ç†è¿‡æœŸé¢„ç®—ç»“è½¬**ï¼šå¤„ç†ä¸Šä¸ªæœˆç»“æŸçš„é¢„ç®—ç»“è½¬
2. **åˆ›å»ºæ–°æœˆä»½é¢„ç®—**ï¼šä¸ºéœ€è¦çš„ç”¨æˆ·åˆ›å»ºå½“å‰æœˆä»½é¢„ç®—
3. **æ¸…ç†å†å²è®°å½•**ï¼šæ¸…ç†è¶…è¿‡ä¸€å¹´çš„é¢„ç®—å†å²è®°å½•

## æ•°æ®æµç¨‹

### ç”¨æˆ·è®¿é—®é¢„ç®—é¡µé¢
```
ç”¨æˆ·è¯·æ±‚ â†’ getActiveBudgets() â†’ æŸ¥è¯¢å½“å‰æœˆä»½é¢„ç®—
    â†“
æ²¡æœ‰æ‰¾åˆ°é¢„ç®— â†’ autoCreateMissingBudgets() â†’ æŸ¥æ‰¾å†å²é¢„ç®—
    â†“
æ‰¾åˆ°å†å²é¢„ç®— â†’ calculateMissingMonths() â†’ è®¡ç®—ç¼ºå¤±æœˆä»½
    â†“
é€æœˆåˆ›å»ºé¢„ç®— â†’ processBudgetRollover() â†’ å¤„ç†ç»“è½¬
    â†“
createNextPeriodBudget() â†’ åˆ›å»ºæ–°é¢„ç®— â†’ è¿”å›é¢„ç®—æ•°æ®
```

### å®šæ—¶ä»»åŠ¡æ‰§è¡Œ
```
æ¯æœˆ1å·å‡Œæ™¨ â†’ runAllScheduledTasks()
    â†“
processExpiredBudgetRollovers() â†’ å¤„ç†ä¸Šæœˆç»“è½¬
    â†“
createMonthlyBudgetsForAllUsers() â†’ æ‰¹é‡åˆ›å»ºé¢„ç®—
    â†“
cleanupOldBudgetHistory() â†’ æ¸…ç†å†å²è®°å½•
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
æ— éœ€é¢å¤–é…ç½®ï¼Œä½¿ç”¨ç°æœ‰çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚

### æ•°æ®åº“è¡¨
ä½¿ç”¨ç°æœ‰çš„è¡¨ç»“æ„ï¼Œå¹¶æ–°å¢refreshDayå­—æ®µï¼š
- `budgets`ï¼šé¢„ç®—ä¸»è¡¨ï¼ˆæ–°å¢ `refresh_day` å­—æ®µï¼‰
- `budget_history`ï¼šé¢„ç®—å†å²è®°å½•è¡¨
- `transactions`ï¼šè®°è´¦è®°å½•è¡¨

#### æ•°æ®åº“å˜æ›´
```sql
-- æ·»åŠ refresh_dayå­—æ®µ
ALTER TABLE "budgets" ADD COLUMN "refresh_day" INTEGER DEFAULT 1;

-- æ·»åŠ çº¦æŸç¡®ä¿æœ‰æ•ˆå€¼
ALTER TABLE "budgets" ADD CONSTRAINT "budgets_refresh_day_check"
CHECK ("refresh_day" IN (1, 5, 10, 15, 20, 25));

-- è®¾ç½®ç°æœ‰æ•°æ®çš„é»˜è®¤å€¼
UPDATE "budgets" SET "refresh_day" = 1 WHERE "refresh_day" IS NULL;
ALTER TABLE "budgets" ALTER COLUMN "refresh_day" SET NOT NULL;
```

### æ—¥å¿—è¾“å‡º
ç³»ç»Ÿä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•ï¼š
```
ç”¨æˆ· xxx åœ¨è´¦æœ¬ xxx ä¸­æ²¡æœ‰æ‰¾åˆ°æ´»è·ƒé¢„ç®—ï¼Œå°è¯•è‡ªåŠ¨åˆ›å»º
æ‰¾åˆ°æœ€è¿‘çš„é¢„ç®—: ä¸ªäººé¢„ç®—, ç»“æŸæ—¥æœŸ: 2024-05-31
éœ€è¦åˆ›å»º 1 ä¸ªæœˆä»½çš„é¢„ç®—
åˆ›å»º 2024-6 çš„é¢„ç®—
æˆåŠŸåˆ›å»ºé¢„ç®—: ä¸ªäººé¢„ç®— (budget-id)
```

## ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§
- ç›‘æ§è‡ªåŠ¨åˆ›å»ºé¢„ç®—çš„é¢‘ç‡å’Œè€—æ—¶
- å…³æ³¨å®šæ—¶ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
- æ£€æŸ¥é¢„ç®—ç»“è½¬è®¡ç®—çš„å‡†ç¡®æ€§

### é”™è¯¯å¤„ç†
- è‡ªåŠ¨åˆ›å»ºå¤±è´¥ä¸ä¼šå½±å“æ­£å¸¸çš„é¢„ç®—æŸ¥è¯¢
- å®šæ—¶ä»»åŠ¡å¤±è´¥ä¼šè®°å½•é”™è¯¯æ—¥å¿—
- æ”¯æŒæ‰‹åŠ¨é‡æ–°æ‰§è¡Œå®šæ—¶ä»»åŠ¡

### æ•°æ®ä¸€è‡´æ€§
- é¢„ç®—åˆ›å»ºä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- ç»“è½¬è®¡ç®—æ”¯æŒé‡æ–°è®¡ç®—åŠŸèƒ½
- å†å²è®°å½•å®Œæ•´ä¿ç•™å®¡è®¡è½¨è¿¹

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç”¨æˆ·ä»ç„¶çœ‹ä¸åˆ°é¢„ç®—æ•°æ®**
   - æ£€æŸ¥æ˜¯å¦æœ‰å†å²é¢„ç®—è®°å½•
   - ç¡®è®¤è´¦æœ¬IDæ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **é¢„ç®—ç»“è½¬é‡‘é¢ä¸æ­£ç¡®**
   - ä½¿ç”¨ `recalculateBudgetRollover` æ–¹æ³•é‡æ–°è®¡ç®—
   - æ£€æŸ¥å†å²è®°è´¦è®°å½•æ˜¯å¦å®Œæ•´
   - ç¡®è®¤é¢„ç®—çš„ç»“è½¬è®¾ç½®

3. **å®šæ—¶ä»»åŠ¡æœªæ‰§è¡Œ**
   - æ£€æŸ¥cron jobé…ç½®
   - æ‰‹åŠ¨æ‰§è¡Œ `npm run budget-scheduler` æµ‹è¯•
   - æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—

### æ‰‹åŠ¨ä¿®å¤
```bash
# ä¸ºç‰¹å®šç”¨æˆ·åˆ›å»ºé¢„ç®—
npm run budget-scheduler

# é‡æ–°è®¡ç®—é¢„ç®—ç»“è½¬
# é€šè¿‡APIè°ƒç”¨ POST /budgets/{id}/recalculate-rollover
```

## ç‰ˆæœ¬å…¼å®¹æ€§

- **å‰ç«¯å…¼å®¹æ€§**ï¼šæ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ï¼ŒAPIæ¥å£ä¿æŒä¸å˜
- **æ•°æ®åº“å…¼å®¹æ€§**ï¼šä½¿ç”¨ç°æœ‰è¡¨ç»“æ„ï¼Œæ— éœ€è¿ç§»
- **å‘åå…¼å®¹**ï¼šç°æœ‰é¢„ç®—æ•°æ®å®Œå…¨å…¼å®¹æ–°åŠŸèƒ½
