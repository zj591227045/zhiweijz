# 日志系统使用指南

## 设计哲学

这是一个**斯巴达式**的日志系统：
- 零依赖
- 零配置
- 零学习成本

## 快速开始

### 1. 导入 logger

```typescript
import { logger } from '../utils/logger';
```

### 2. 使用日志

```typescript
// 调试信息（开发环境）
logger.debug('用户ID:', userId, '账本ID:', accountBookId);

// 一般信息
logger.info('用户登录成功:', username);

// 警告信息
logger.warn('Token即将过期:', tokenId);

// 错误信息
logger.error('数据库连接失败:', error);
```

## 日志级别

| 级别 | 用途 | 示例 |
|------|------|------|
| DEBUG | 调试信息，仅开发环境 | 函数参数、中间变量、执行流程 |
| INFO | 重要业务事件 | 用户登录、订单创建、支付成功 |
| WARN | 警告但不影响运行 | 配置缺失、性能问题、即将过期 |
| ERROR | 错误需要关注 | 异常捕获、数据库错误、API失败 |

## 环境变量配置

在 `.env` 文件中设置：

```bash
# 开发环境：显示所有日志
LOG_LEVEL=DEBUG

# 生产环境：只显示重要信息
LOG_LEVEL=INFO

# 问题排查：只看错误
LOG_LEVEL=ERROR
```

## 日志格式

所有日志自动包含：
- **时间戳**：ISO 8601 格式
- **级别**：DEBUG/INFO/WARN/ERROR
- **内容**：你传入的参数

示例输出：
```
[2025-12-12T10:30:45.123Z] [INFO] 用户登录成功: zhangsan
[2025-12-12T10:30:46.456Z] [ERROR] 数据库连接失败: {"code":"ECONNREFUSED"}
```

## 迁移指南

### 自动迁移（推荐）

运行迁移脚本：

```bash
node scripts/migrate-to-logger.js
```

脚本会自动：
1. 在文件顶部添加 `import { logger }`
2. 替换所有 `console.log` → `logger.info`
3. 替换所有 `console.error` → `logger.error`
4. 替换所有 `console.warn` → `logger.warn`
5. 替换所有 `console.debug` → `logger.debug`

### 手动迁移

如果需要手动调整日志级别：

**之前：**
```typescript
console.log('开始处理订单:', orderId);  // 不知道重要性
```

**之后：**
```typescript
logger.info('开始处理订单:', orderId);   // 业务事件用 info
logger.debug('订单详情:', orderData);    // 调试信息用 debug
```

## 最佳实践

### ✅ 好的做法

```typescript
// 1. 业务关键事件用 INFO
logger.info('用户注册成功:', userId);

// 2. 调试信息用 DEBUG
logger.debug('查询参数:', { page, limit, filter });

// 3. 错误包含上下文
logger.error('创建订单失败:', { userId, productId, error });

// 4. 警告说明原因
logger.warn('使用默认配置，因为环境变量未设置');
```

### ❌ 避免的做法

```typescript
// 1. 不要在循环中打印 INFO
for (const item of items) {
  logger.info('处理项目:', item);  // ❌ 太多日志
}
// 应该用 DEBUG 或只打印汇总
logger.debug('处理项目:', item);   // ✅
logger.info('批量处理完成:', items.length);  // ✅

// 2. 不要打印敏感信息
logger.info('用户密码:', password);  // ❌ 安全问题

// 3. 不要打印无用信息
logger.info('进入函数');  // ❌ 没有价值
```

## 性能说明

- **DEBUG 级别**：生产环境自动跳过，零性能开销
- **对象序列化**：自动 JSON.stringify，无需手动转换
- **无文件写入**：直接输出到 stdout/stderr，由运行环境处理

## 与现有系统集成

日志输出到标准输出，可以：
- Docker 环境：自动收集到容器日志
- PM2：自动写入日志文件
- Systemd：自动记录到 journal
- 云平台：自动上传到日志服务

无需额外配置。

## 故障排查

### 问题：看不到 DEBUG 日志

**原因**：环境变量设置为 INFO 或更高级别

**解决**：
```bash
# 临时启用
LOG_LEVEL=DEBUG npm run server:dev

# 或修改 .env
LOG_LEVEL=DEBUG
```

### 问题：日志太多

**原因**：级别设置为 DEBUG

**解决**：
```bash
# 生产环境使用
LOG_LEVEL=INFO
```

### 问题：时间戳时区不对

**说明**：时间戳使用 UTC（ISO 8601 标准），这是正确的做法。
如需本地时间，由日志查看工具转换。

## 总结

这个日志系统的核心思想：
1. **简单**：50行代码，无依赖
2. **够用**：满足 99% 的日志需求
3. **高效**：DEBUG 日志零开销

不需要 winston、pino 这些复杂的库。
