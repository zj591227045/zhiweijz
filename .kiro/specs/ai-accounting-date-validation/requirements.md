# 需求文档

## 简介

本文档定义了AI记账日期校验与修正功能的需求。当前AI记账(图片/语音转文字后)存在日期处理缺陷,会产生未来日期或1年前的错误日期。本功能将通过日期合理性校验和智能修正,确保记账数据的准确性。

## 术语表

- **AI记账**: 通过图片识别(OCR)或语音识别(ASR)转换为文字后,调用LLM进行智能记账的功能
- **LLM**: Large Language Model,大语言模型,用于解析记账文本并提取结构化信息
- **记账日期**: 交易发生的日期,由AI从识别文本中提取或使用默认值
- **合理日期范围**: 过去7天到今天的日期区间,超出此范围视为异常
- **微信记账**: 通过微信公众号进行的记账,无法进行交互式日期修改
- **App记账**: 通过移动应用进行的记账,支持弹窗交互修改日期
- **日期校验中间件**: 在LLM解析结果和数据库写入之间的日期验证与修正逻辑层

## 需求

### 需求 1: 默认日期兜底机制

**用户故事**: 作为用户,当AI无法识别记账日期时,我希望系统自动使用今天的日期,这样我的记账记录不会出现空白日期。

#### 验收标准

1. WHEN AI识别结果中日期字段为null或undefined THEN 系统SHALL将日期设置为当前日期(北京时区)
2. WHEN AI识别结果中日期字段为空字符串 THEN 系统SHALL将日期设置为当前日期(北京时区)
3. WHEN 设置默认日期后 THEN 系统SHALL在日志中记录"使用默认日期"的信息
4. WHEN 使用默认日期 THEN 系统SHALL保留时分秒为当前时间

### 需求 2: 日期合理性校验

**用户故事**: 作为用户,当AI识别出的日期不合理时(如未来日期或很久以前的日期),我希望系统能够检测并提醒我,避免错误数据进入系统。

#### 验收标准

1. WHEN 记账日期晚于今天 THEN 系统SHALL判定为日期异常
2. WHEN 记账日期不在本月且早于"今天-7天" THEN 系统SHALL判定为日期异常
3. WHEN 记账日期在本月内或在"今天-7天"到"今天"范围内 THEN 系统SHALL判定为日期正常
4. WHEN 日期异常且来源为App THEN 系统SHALL触发日期修正流程
5. WHEN 日期异常且来源为微信 THEN 系统SHALL强制设置日期为今天并记录警告

### 需求 3: App端交互式日期修正

**用户故事**: 作为App用户,当系统检测到日期异常时,我希望看到一个弹窗提示,并能手动修改日期,这样我可以纠正AI的识别错误。

#### 验收标准

1. WHEN 日期异常且来源为App THEN 系统SHALL返回特殊响应标识requiresDateCorrection=true
2. WHEN 返回日期修正响应 THEN 系统SHALL包含原始识别日期、建议日期(今天)、异常原因
3. WHEN 前端收到日期修正响应 THEN 系统SHALL显示模态框提示用户
4. WHEN 模态框显示 THEN 系统SHALL提供日期选择器供用户修改
5. WHEN 用户确认修改后的日期 THEN 系统SHALL使用用户选择的日期创建记账记录
6. WHEN 用户取消修正 THEN 系统SHALL使用今天的日期创建记账记录

### 需求 4: 微信端自动修正与警告

**用户故事**: 作为微信用户,由于微信无法弹窗交互,当系统检测到日期异常时,我希望系统自动修正为今天,并在返回消息中明确告知我,这样我知道日期被调整了。

#### 验收标准

1. WHEN 日期异常且来源为微信 THEN 系统SHALL自动将日期设置为今天
2. WHEN 微信端自动修正日期 THEN 系统SHALL在返回消息中添加警告文本
3. WHEN 警告文本显示 THEN 系统SHALL包含原始识别日期和修正后日期
4. WHEN 警告文本显示 THEN 系统SHALL使用醒目的emoji标识(如⚠️)
5. WHEN 微信端返回成功消息 THEN 系统SHALL将日期警告作为独立段落显示

### 需求 5: 日期校验日志记录

**用户故事**: 作为系统管理员,我希望所有日期校验和修正操作都被详细记录,这样我可以追踪和分析日期异常的模式。

#### 验收标准

1. WHEN 执行日期校验 THEN 系统SHALL记录原始日期、校验结果、来源渠道
2. WHEN 日期被修正 THEN 系统SHALL记录修正前后的日期值和修正原因
3. WHEN 日志记录 THEN 系统SHALL包含用户ID、账本ID、记账ID
4. WHEN 日志记录 THEN 系统SHALL使用统一的日志格式便于检索
5. WHEN 日志级别 THEN 系统SHALL对异常日期使用WARN级别,正常日期使用INFO级别

### 需求 6: 多条记录批量校验

**用户故事**: 作为用户,当图片识别出多条记账记录时,我希望系统能够对每条记录的日期进行独立校验,确保所有记录的日期都是准确的。

#### 验收标准

1. WHEN 处理多条记账记录 THEN 系统SHALL对每条记录独立执行日期校验
2. WHEN 批量校验中有异常日期 THEN 系统SHALL标记具体哪条记录存在异常
3. WHEN App端批量记录有异常 THEN 系统SHALL在记录选择界面标注日期异常并允许用户修改
4. WHEN 微信端批量记录有异常 THEN 系统SHALL自动修正异常日期并在返回消息中逐条说明
5. WHEN 批量校验完成 THEN 系统SHALL在日志中记录总记录数和异常记录数

### 需求 7: 兼容现有多条记录选择流程

**用户故事**: 作为开发者,我希望日期校验功能能够无缝集成到现有的多条记录选择流程中,不破坏现有的用户体验。

#### 验收标准

1. WHEN 图片识别返回多条记录且需要用户选择 THEN 系统SHALL在每条记录中附加日期校验结果
2. WHEN 前端显示记录选择列表 THEN 系统SHALL对日期异常的记录显示警告标识
3. WHEN 用户选择包含日期异常的记录 THEN 系统SHALL在创建前再次校验并提示修正
4. WHEN 用户在选择界面修改日期 THEN 系统SHALL实时校验修改后的日期
5. WHEN 所有选中记录的日期都正常 THEN 系统SHALL直接创建记账记录无需额外提示
