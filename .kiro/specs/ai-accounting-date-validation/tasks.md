# 实现计划

- [x] 1. 创建日期校验核心服务
  - 实现DateValidationService类,包含日期范围判断逻辑
  - 实现日期校验的核心算法:判断日期是否在"本月内"或"过去7天内"
  - 实现北京时区的日期处理工具函数
  - _需求: 1.1, 1.2, 2.1, 2.2, 2.3_

- [ ]* 1.1 编写日期校验服务的属性测试
  - **属性 1: 空日期默认值一致性**
  - **属性 2: 未来日期检测准确性**
  - **属性 3: 历史日期检测准确性**
  - **属性 4: 合理日期通过性**
  - **验证: 需求 1.1, 1.2, 1.4, 2.1, 2.2, 2.3**

- [x] 2. 实现日期修正中间件
  - 创建DateCorrectionMiddleware类
  - 实现单条记录的日期校验和修正逻辑
  - 实现批量记录的日期校验和修正逻辑
  - 实现来源感知的处理策略(App返回提示,微信自动修正)
  - _需求: 2.4, 2.5, 6.1, 6.2_

- [ ]* 2.1 编写日期修正中间件的属性测试
  - **属性 5: 来源感知处理一致性**
  - **属性 10: 批量校验独立性**
  - **属性 11: 批量异常标记准确性**
  - **验证: 需求 2.4, 2.5, 6.1, 6.2**

- [x] 3. 集成到智能记账控制器(App端)
  - 在AIController的handleSmartAccounting方法中集成日期校验中间件
  - 处理日期异常时返回requiresDateCorrection响应
  - 实现前端日期修正API端点
  - 更新createSelectedTransactions方法支持用户修改后的日期
  - _需求: 3.1, 3.2, 3.5, 3.6_

- [ ]* 3.1 编写App端集成的属性测试
  - **属性 6: App端修正响应完整性**
  - **验证: 需求 3.1, 3.2**

- [x] 4. 集成到微信记账服务
  - 在WechatSmartAccountingService中集成日期校验中间件
  - 实现WechatMessageFormatter类
  - 实现日期异常时的自动修正逻辑
  - 实现警告消息的格式化和附加
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 4.1 编写微信端集成的属性测试
  - **属性 7: 微信端警告消息完整性**
  - **验证: 需求 4.2, 4.3, 4.4**

- [x] 5. 实现日志记录系统
  - 创建DateValidationLogger类
  - 实现统一的日志格式
  - 实现日志级别控制(INFO/WARN)
  - 实现批量校验统计日志
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 5.1 编写日志系统的属性测试
  - **属性 8: 日志记录完整性**
  - **属性 9: 日志级别正确性**
  - **验证: 需求 5.1, 5.3, 5.5**

- [x] 6. 兼容多条记录选择流程
  - 更新SmartAccounting的generateResultHandler,为每条记录附加日期校验结果
  - 更新前端记录选择界面,显示日期异常标识
  - 实现选择界面的日期修改功能
  - 实现创建前的二次校验逻辑
  - _需求: 7.1, 7.3, 7.4, 7.5_

- [ ]* 6.1 编写多条记录流程的属性测试
  - **属性 12: 记录选择数据扩展性**
  - **属性 13: 二次校验一致性**
  - **属性 14: 修改后日期校验实时性**
  - **验证: 需求 7.1, 7.3, 7.4**

- [x] 7. 添加配置和错误处理
  - 创建DateValidationConfig配置接口
  - 实现配置加载和默认值
  - 实现错误场景的降级处理
  - 实现时区转换错误的回退逻辑
  - _需求: 所有需求的错误处理_

- [ ]* 7.1 编写错误处理的单元测试
  - 测试日期解析失败的降级
  - 测试时区转换错误的回退
  - 测试批量处理部分失败的处理
  - 测试日志写入失败的静默处理

- [x] 8. 前端UI实现
  - 创建日期修正模态框组件
  - 实现日期选择器
  - 实现记录选择界面的日期异常标识
  - 实现实时日期校验反馈
  - _需求: 3.3, 3.4, 7.2_

- [ ]* 8.1 编写前端组件的单元测试
  - 测试模态框的显示和隐藏
  - 测试日期选择器的交互
  - 测试异常标识的显示逻辑

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过,如有问题请询问用户

- [x] 10. 集成测试和端到端测试
  - 测试App端图片记账完整流程
  - 测试微信端语音记账完整流程
  - 测试批量记录的混合场景
  - 测试边界情况(月末、跨月、闰年等)
  - _需求: 所有需求的集成验证_

- [ ]* 10.1 编写集成测试用例
  - App端日期异常修正流程
  - 微信端日期自动修正流程
  - 批量记录部分异常处理
  - 边界日期处理

- [x] 11. 性能优化和监控
  - 实现日期计算结果缓存
  - 实现批量处理并行优化
  - 实现日志异步写入
  - 添加性能监控指标
  - _需求: 性能目标_

- [ ]* 11.1 编写性能测试
  - 测试单次校验耗时
  - 测试批量校验耗时
  - 测试日志写入延迟

- [x] 12. 文档和部署准备
  - 编写API文档
  - 编写配置说明文档
  - 编写运维监控文档
  - 准备数据库迁移脚本(如需要)
  - _需求: 部署考虑_

- [x] 13. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过,如有问题请询问用户
